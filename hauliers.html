
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Azelis Shipping - Haulier Management</title>
    <link rel="icon" href="https://www.azelis.com/themes/custom/azelis_theme/favicon.ico" type="image/x-icon">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    
    <!-- Load dependencies in correct order -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        .azelis-blue { background-color: #003087; }
        .azelis-blue-hover:hover { background-color: #002670; }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltip-text {
            visibility: hidden;
            background-color: #333;
            color: white;
            text-align: center;
            padding: 5px;
            border-radius: 6px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
        }
        .tooltip:hover .tooltip-text {
            visibility: visible;
        }
    </style>
</head>
<body class="bg-gray-50">
    <header class="azelis-blue text-white p-4 shadow-lg">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <img src="https://www.azelis.com/themes/custom/azelis_theme/logo.svg" alt="Azelis Logo" class="h-8">
                <h1 class="text-xl font-bold">Haulier Management</h1>
            </div>
            <nav class="flex space-x-4">
                <a href="index.html" class="text-white hover:text-gray-200">Calculator</a>
                <a href="hauliers.html" class="text-white hover:text-gray-200 font-bold">Haulier Management</a>
            </nav>
        </div>
    </header>

    <div id="root"></div>
    <!-- Initialize Firebase -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDiIRLwLeMAf1VZbZ7ygvGDu-gZH6sA424",
            authDomain: "azelislogistics.firebaseapp.com",
            projectId: "azelislogistics",
            storageBucket: "azelislogistics.appspot.com",
            messagingSenderId: "13102382958",
            appId: "1:13102382958:web:82a3324843432519cb8b7f",
            measurementId: "G-Q6JNN8DHJQ"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
    </script>

    <!-- React Component -->
    <script type="text/babel">
        const allowedCountries = [
            "AFG", "ALB", "DZA", "AND", "AGO", "ATG", "ARG", "ARM", "AUS", "AUT",
            "AZE", "BHS", "BHR", "BGD", "BRB", "BLR", "BEL", "BLZ", "BEN", "BTN",
            "BOL", "BIH", "BWA", "BRA", "BRN", "BGR", "BFA", "BDI", "CPV", "KHM",
            "CMR", "CAN", "CAF", "TCD", "CHL", "CHN", "COL", "COM", "COG", "COD",
            "CRI", "CIV", "HRV", "CUB", "CYP", "CZE", "DNK", "DJI", "DMA", "DOM",
            "ECU", "EGY", "SLV", "GNQ", "ERI", "EST", "SWZ", "ETH", "FJI", "FIN",
            "FRA", "GAB", "GMB", "GEO", "GER", "GHA", "GRC", "GRD", "GTM", "GIN",
            "GNB", "GUY", "HTI", "HND", "HUN", "ISL", "IND", "IDN", "IRN", "IRQ",
            "IRL", "ISR", "ITA", "JAM", "JPN", "JOR", "KAZ", "KEN", "KIR", "PRK",
            "KOR", "KWT", "KGZ", "LAO", "LVA", "LBN", "LSO", "LBR", "LBY", "LIE",
            "LTU", "LUX", "MDG", "MWI", "MYS", "MDV", "MLI", "MLT", "MHL", "MRT",
            "MUS", "MEX", "FSM", "MDA", "MCO", "MNG", "MNE", "MAR", "MOZ", "MMR",
            "NAM", "NRU", "NPL", "NLD", "NZL", "NIC", "NER", "NGA", "NOR", "OMN",
            "PAK", "PLW", "PAN", "PNG", "PRY", "PER", "PHL", "POL", "PRT", "QAT",
            "ROU", "RUS", "RWA", "KNA", "LCA", "VCT", "WSM", "SMR", "STP", "SAU",
            "SEN", "SRB", "SYC", "SLE", "SGP", "SVK", "SVN", "SLB", "SOM", "ZAF",
            "SSD", "ESP", "LKA", "SDN", "SUR", "SWE", "CHE", "SYR", "TWN", "TJK",
            "TZA", "THA", "TLS", "TGO", "TON", "TTO", "TUN", "TUR", "TKM", "TUV",
            "UGA", "UKR", "ARE", "GBR", "USA", "URY", "UZB", "VUT", "VAT", "VEN",
            "VNM", "YEM", "ZMB", "ZWE"
        ];

        const HaulierManagement = () => {
            // Basic state management
            const [activeTab, setActiveTab] = React.useState('hauliers');
            const [hauliers, setHauliers] = React.useState([]);
            const [rates, setRates] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            
            // Modal states
            const [showHaulierForm, setShowHaulierForm] = React.useState(false);
            const [showRateForm, setShowRateForm] = React.useState(false);
            const [showRateDetails, setShowRateDetails] = React.useState(false);
            
            // Edit states
            const [editingHaulier, setEditingHaulier] = React.useState(null);
            const [editingRate, setEditingRate] = React.useState(null);
            const [selectedRate, setSelectedRate] = React.useState(null);
            
            // Import/Export states
            const [importErrors, setImportErrors] = React.useState([]);
            const [importStats, setImportStats] = React.useState(null);

            // Filter states
            const [rateFilters, setRateFilters] = React.useState({
                haulier: '',
                collectionCountry: '',
                deliveryCountry: '',
                transportMode: '',
                deliveryType: ''
            });

            React.useEffect(() => {
                // Fetch hauliers from Firebase
                const unsubscribeHauliers = db.collection('hauliers').onSnapshot(snapshot => {
                    const hauliersData = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setHauliers(hauliersData);
                    setLoading(false);
                }, error => {
                    console.error('Error fetching hauliers:', error);
                    setLoading(false);
                });

                // Fetch rates from Firebase
                const unsubscribeRates = db.collection('rates').onSnapshot(snapshot => {
                    const ratesData = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setRates(ratesData);
                }, error => {
                    console.error('Error fetching rates:', error);
                });

                // Cleanup subscriptions on unmount
                return () => {
                    unsubscribeHauliers();
                    unsubscribeRates();
                };
            }, []);

            // Haulier Management Functions
            const handleHaulierSubmit = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const selectedCountries = formData.getAll('operatingCountries');
                const transportModes = formData.getAll('transportModes');
            
                if (selectedCountries.length === 0) {
                    alert('Please select at least one country of delivery.');
                    return;
                }
            
                if (transportModes.length === 0) {
                    alert('Please select at least one transport mode.');
                    return;
                }
            
                const haulierData = {
                    name: formData.get('name'),
                    email: formData.get('email'),
                    phone: formData.get('phone'),
                    countries: selectedCountries,
                    transportModes: transportModes,  // Add this line
                    services: formData.getAll('services'),
                    certifications: formData.getAll('certifications'),
                    active: true,
                    updatedAt: new Date()
                };
            
                try {
                    if (editingHaulier) {
                        await db.collection('hauliers').doc(editingHaulier.id).update({
                            ...haulierData,
                            updatedAt: new Date()
                        });
                    } else {
                        await db.collection('hauliers').add({
                            ...haulierData,
                            createdAt: new Date()
                        });
                    }
                    setShowHaulierForm(false);
                    setEditingHaulier(null);
                } catch (error) {
                    console.error('Error saving haulier:', error);
                    alert('Error saving haulier. Please try again.');
                }
            };

            const handleHaulierDelete = async (id) => {
                if (!confirm('Are you sure you want to delete this haulier? This will also remove all associated rates.')) {
                    return;
                }

                try {
                    // Delete the haulier
                    await db.collection('hauliers').doc(id).delete();

                    // Delete all rates associated with this haulier
                    const ratesSnapshot = await db.collection('rates')
                        .where('haulierId', '==', id)
                        .get();

                    const batch = db.batch();
                    ratesSnapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();

                } catch (error) {
                    console.error('Error deleting haulier:', error);
                    alert('Error deleting haulier and associated rates. Please try again.');
                }
            };

            const handleToggleActive = async (id, currentActive) => {
                try {
                    await db.collection('hauliers').doc(id).update({
                        active: !currentActive,
                        updatedAt: new Date()
                    });
                } catch (error) {
                    console.error('Error updating haulier status:', error);
                    alert('Error updating haulier status. Please try again.');
                }
            };

            const getHaulierRatesCount = (haulierId) => {
                return rates.filter(rate => rate.haulierId === haulierId).length;
            };

            const getHaulierNameById = (haulierId) => {
                const haulier = hauliers.find(h => h.id === haulierId);
                return haulier ? haulier.name : 'Unknown Haulier';
            };

            const getHaulierPerformanceStats = (haulierId) => {
                const haulierRates = rates.filter(rate => rate.haulierId === haulierId);
                const today = new Date();
                
                return {
                    totalRoutes: haulierRates.length,
                    activeRoutes: haulierRates.filter(rate => new Date(rate.priceValidity) > today).length,
                    uniqueCountries: new Set([
                        ...haulierRates.map(rate => rate.collectionCountry),
                        ...haulierRates.map(rate => rate.deliveryCountry)
                    ]).size,
                    services: new Set(haulierRates.flatMap(rate => rate.deliveryType)).size
                };
            };

            // Rate Management Functions
            const handleRateSubmit = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const loadType = formData.get('loadType');

                const rateData = {
                    // Basic route info
                    collectionCountry: formData.get('collectionCountry'),
                    collectionPostcode: formData.get('collectionPostcode') || '',
                    deliveryCountry: formData.get('deliveryCountry'),
                    deliveryPostcode: formData.get('deliveryPostcode') || '',
                    
                    // Transport details
                    transportMode: formData.get('transportMode'),
                    weightBucket: formData.get('weightBucket'),
                    incoterms: formData.get('incoterms'),
                    deliveryType: formData.get('deliveryType') || 'STD',
                    
                    // Pricing and validity
                    priceValidity: formData.get('priceValidity'),
                    currency: formData.get('currency'),
                    isFullTruckLoad: formData.get('loadType') === 'ftl',
                    
                    // Associated haulier
                    haulierId: formData.get('haulierId'),
                    haulierName: getHaulierNameById(formData.get('haulierId')),
                    
                    // Service details
                    transitTime: parseInt(formData.get('transitTime')) || null,
                    services: formData.getAll('services'),
                    
                    // Container/Air freight specific
                    containerType: formData.get('containerType') || null,
                    airWeight: formData.get('airWeight') ? parseFloat(formData.get('airWeight')) : null,
                    volume: formData.get('volume') ? parseFloat(formData.get('volume')) : null,

                    // Price handling
                    prices: {},
                    fullTruckLoadPrice: null,
                    
                    // Metadata
                    updatedAt: new Date()
                };

                // Handle pricing based on load type
                if (rateData.isFullTruckLoad) {
                    rateData.fullTruckLoadPrice = parseFloat(formData.get('ftlPrice')) || null;
                } else {
                    // Collect pallet prices
                    for (let i = 1; i <= 24; i++) {
                        const price = formData.get(`${i}Pallet`);
                        if (price) {
                            rateData.prices[i] = parseFloat(price);
                        }
                    }
                }

                try {
                    if (editingRate) {
                        await db.collection('rates').doc(editingRate.id).update(rateData);
                    } else {
                        rateData.createdAt = new Date();
                        await db.collection('rates').add(rateData);
                    }
                    setShowRateForm(false);
                    setEditingRate(null);
                } catch (error) {
                    console.error('Error saving rate:', error);
                    alert('Error saving rate. Please try again.');
                }
            };

            const handleRateDelete = async (id) => {
                if (!confirm('Are you sure you want to delete this rate?')) {
                    return;
                }

                try {
                    await db.collection('rates').doc(id).delete();
                } catch (error) {
                    console.error('Error deleting rate:', error);
                    alert('Error deleting rate. Please try again.');
                }
            };

            const handleRatesImport = async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { defval: '' });

                        const errors = [];
                        const validData = [];
                        const stats = {
                            total: jsonData.length,
                            valid: 0,
                            invalid: 0,
                            updated: 0,
                            created: 0
                        };

                        for (const row of jsonData) {
                            const isValid = validateRateData(row);
                            if (isValid === true) {
                                validData.push(transformRateData(row));
                                stats.valid++;
                            } else {
                                errors.push(`Row ${jsonData.indexOf(row) + 2}: ${isValid}`);
                                stats.invalid++;
                            }
                        }

                        if (validData.length > 0) {
                            // Process and save each valid rate to Firebase
                            const batch = db.batch();
                            for (const rate of validData) {
                                const rateRef = db.collection('rates').doc();
                                batch.set(rateRef, {
                                    ...rate,
                                    createdAt: new Date(),
                                    updatedAt: new Date()
                                });
                            }

                            await batch.commit();
                            setImportStats(stats);
                        }

                        if (errors.length > 0) {
                            setImportErrors(errors);
                        }
                        
                        event.target.value = ''; // Reset file input
                    } catch (error) {
                        console.error('Error importing rates:', error);
                        alert('Failed to import rates. Please check the file format.');
                    }
                };
                reader.readAsArrayBuffer(file);
            };

            const handleRatesExport = () => {
                if (rates.length === 0) {
                    alert('No rates to export.');
                    return;
                }
            
                const exportData = rates.map(rate => {
                    // Start with basic rate information
                    const baseData = {
                        'Quote ID': rate.quoteId || '',
                        'Haulier ID': rate.haulierId || '',
                        'Haulier Name': rate.haulierName || '',
                        'Haulier Email': rate.haulierEmail || '',
                        'User Email': rate.userEmail || '',
                        'Currency': rate.currency || '',
                        'Valid Until': rate.validUntil || '',
                        'Transit Time': rate.transitTime || '',
                        'Fixed Rate Surcharges': rate.fixedRateSurcharges || '',
                        'Percent Surcharge': rate.percentSurcharge || '',
                        'Hide Documents': rate.hideDocuments ? 'Yes' : 'No',
                        'Include Customs Clearance': rate.includeCustomsClearance ? 'Yes' : 'No',
                        'Submission Date': rate.submittedAt ? rate.submittedAt.toDate().toLocaleDateString() : '',
                        'Transport Mode': rate.transportMode || '',
                        'Haulier Transport Modes': rate.haulierTransportModes ? rate.haulierTransportModes.join(', ') : '',
                        
                        // Collection Details
                        'Collection Country': rate.collection?.country || rate.collectionCountry || '',
                        'Collection Postcode': rate.collection?.postcode || rate.collectionPostcode || '',
                        'Collection Location': rate.collection?.location || '',
                        
                        // Delivery Details
                        'Delivery Country': rate.delivery?.country || rate.deliveryCountry || '',
                        'Delivery Postcode': rate.delivery?.postcode || rate.deliveryPostcode || '',
                        'Delivery Location': rate.delivery?.location || '',
                        
                        // Transport Details
                        'Weight Bucket': rate.weightBucket || '',
                        'Weight Type': rate.weightType || '',
                        'Incoterms': rate.incoterms || '',
                        'Delivery Type': rate.deliveryType || '',
                        'Load Type': rate.loadType || '',
                        'Number of Pallets': rate.pallets || '',
                        'Volume (CBM)': rate.volume || '',
                        'Pallet Type': rate.palletType || '',
                        'Container Type': rate.containerType || '',
                        'Air Weight (KG)': rate.airWeight || '',
                        
                        // Additional Details
                        'Is Peak Season': rate.isPeakSeason ? 'Yes' : 'No',
                        'Peak Season Details': rate.peakSeasonDetails || '',
                        'Urgency': rate.urgency || '',
                        'Preferred Delivery Date': rate.preferredDeliveryDate || '',
                    };
            
                    // Add waypoints
                    if (rate.waypoints) {
                        rate.waypoints.forEach((wp, index) => {
                            baseData[`Waypoint ${index + 1} Country`] = wp.country || '';
                            baseData[`Waypoint ${index + 1} Postcode`] = wp.postcode || '';
                        });
                    }
            
                    // Add pricing information
                    if (rate.isFullTruckLoad) {
                        baseData['Full Truck Load Price'] = rate.fullTruckLoadPrice || '';
                    } else if (rate.rates) {
                        Object.entries(rate.rates).forEach(([key, value]) => {
                            baseData[`${key} Rate`] = value.rate || '';
                            baseData[`${key} Total`] = value.total || '';
                        });
                    } else if (rate.prices) {
                        Object.entries(rate.prices).forEach(([pallets, price]) => {
                            baseData[`${pallets} Pallet Price`] = price || '';
                        });
                    }
            
                    return baseData;
                });
            
                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Rates");
                XLSX.writeFile(wb, "azelis_rates.xlsx");
            };

            // Utility and Validation Functions
            const validateRateData = (row) => {
                // Required fields validation
                const requiredFields = [
                    'Collection Country', 'Delivery Country', 
                    'Transport Mode', 'Weight Bucket', 'Incoterms',
                    'Haulier ID', 'Price Validity', 'Currency'
                ];

                for (const field of requiredFields) {
                    if (!row[field]) {
                        return `Missing required field: ${field}`;
                    }
                }

                // Country code validation
                if (!allowedCountries.includes(row['Collection Country'])) {
                    return 'Invalid collection country code';
                }
                if (!allowedCountries.includes(row['Delivery Country'])) {
                    return 'Invalid delivery country code';
                }

                // Haulier existence validation
                const haulierExists = hauliers.some(h => h.id === row['Haulier ID']);
                if (!haulierExists) {
                    return 'Invalid haulier ID';
                }

                // Transport mode validation
                const validModes = ['Road', 'Sea', 'Air'];
                if (!validModes.includes(row['Transport Mode'])) {
                    return 'Invalid transport mode';
                }

                // Weight bucket validation
                const validWeightBuckets = ['<500kg', '500kg-1ton', '1ton-5tons', '>5tons'];
                if (!validWeightBuckets.includes(row['Weight Bucket'])) {
                    return 'Invalid weight bucket';
                }

                // Price validity date validation
                const validityDate = new Date(row['Price Validity']);
                if (isNaN(validityDate.getTime())) {
                    return 'Invalid price validity date';
                }

                // Currency validation
                const validCurrencies = ['GBP', 'EUR', 'USD'];
                if (!validCurrencies.includes(row['Currency'])) {
                    return 'Invalid currency';
                }

                return true;
            };

            const transformRateData = (row) => {
                const transformed = {
                    collectionCountry: row['Collection Country'],
                    collectionPostcode: row['Collection Postcode'] || '',
                    deliveryCountry: row['Delivery Country'],
                    deliveryPostcode: row['Delivery Postcode'] || '',
                    transportMode: row['Transport Mode'],
                    weightBucket: row['Weight Bucket'],
                    incoterms: row['Incoterms'],
                    deliveryType: row['Delivery Type'] || 'STD',
                    priceValidity: row['Price Validity'],
                    currency: row['Currency'],
                    haulierId: row['Haulier ID'],
                    haulierName: getHaulierNameById(row['Haulier ID']),
                    isFullTruckLoad: row['Is Full Truck Load']?.toLowerCase() === 'yes',
                    transitTime: parseInt(row['Transit Time']) || null,
                    services: row['Services']?.split(',').map(s => s.trim()) || [],
                    containerType: row['Container Type'] || null,
                    airWeight: row['Air Weight'] ? parseFloat(row['Air Weight']) : null,
                    volume: row['Volume'] ? parseFloat(row['Volume']) : null,
                    prices: {},
                    fullTruckLoadPrice: null
                };

                // Handle pricing based on load type
                if (transformed.isFullTruckLoad) {
                    transformed.fullTruckLoadPrice = row['Full Truck Load Price'] 
                        ? parseFloat(row['Full Truck Load Price']) 
                        : null;
                } else {
                    // Extract pallet prices
                    for (let i = 1; i <= 24; i++) {
                        const price = row[`${i} Pallet`];
                        if (price) {
                            transformed.prices[i] = parseFloat(price);
                        }
                    }
                }

                return transformed;
            };

            const generatePalletPriceColumns = (prices) => {
                const columns = {};
                for (let i = 1; i <= 24; i++) {
                    columns[`${i} Pallet`] = prices?.[i] || '';
                }
                return columns;
            };

            const formatDate = (dateStr) => {
                const date = new Date(dateStr);
                return date.toLocaleDateString('en-GB', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                });
            };

            const formatCurrency = (amount, currency) => {
                if (amount === null || amount === undefined) return 'N/A';
                
                const formatter = new Intl.NumberFormat('en-GB', {
                    style: 'currency',
                    currency: currency
                });
                return formatter.format(amount);
            };

            const filterRates = (rates) => {
                return rates.filter(rate => {
                    if (rateFilters.haulier && rate.haulierId !== rateFilters.haulier) return false;
                    if (rateFilters.collectionCountry && rate.collectionCountry !== rateFilters.collectionCountry) return false;
                    if (rateFilters.deliveryCountry && rate.deliveryCountry !== rateFilters.deliveryCountry) return false;
                    if (rateFilters.transportMode && rate.transportMode !== rateFilters.transportMode) return false;
                    if (rateFilters.deliveryType && rate.deliveryType !== rateFilters.deliveryType) return false;
                    return true;
                });
            };

            // Main Render Function
            if (loading) {
                return (
                    <div className="flex items-center justify-center h-64">
                        <div className="text-lg">Loading...</div>
                    </div>
                );
            }

            return (
                <div className="max-w-7xl mx-auto p-4">
                    <div className="bg-white rounded-lg shadow-lg p-6">
                        {/* Tabs */}
                        <div className="flex border-b mb-4">
                            <button
                                onClick={() => setActiveTab('hauliers')}
                                className={`mr-4 pb-2 ${activeTab === 'hauliers' ? 'border-b-2 border-blue-600' : ''}`}
                            >
                                Hauliers
                            </button>
                            <button
                                onClick={() => setActiveTab('rates')}
                                className={`pb-2 ${activeTab === 'rates' ? 'border-b-2 border-blue-600' : ''}`}
                            >
                                Rates
                            </button>
                        </div>

                        {/* Content based on active tab */}
                        {activeTab === 'hauliers' && (
                            <div>
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-xl font-bold">Registered Hauliers</h2>
                                    <button
                                        onClick={() => setShowHaulierForm(true)}
                                        className="azelis-blue text-white px-4 py-2 rounded hover:bg-blue-700"
                                    >
                                        Add Haulier
                                    </button>
                                </div>

                                {/* Hauliers Table */}
                                <div className="overflow-x-auto">
                                    <table className="w-full">
                                        <thead className="bg-gray-50">
                                            <tr>
                                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Company
                                                </th>
                                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Contact
                                                </th>
                                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Transport Modes
                                                </th>
                                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Countries
                                                </th>
                                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Statistics
                                                </th>
                                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Status
                                                </th>
                                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Actions
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody className="bg-white divide-y divide-gray-200">
                                            {hauliers.map(haulier => {
                                                const stats = getHaulierPerformanceStats(haulier.id);
                                                return (
                                                    <tr key={haulier.id}>
                                                        <td className="px-6 py-4">
                                                            <div className="font-medium text-gray-900">{haulier.name}</div>
                                                            <div className="text-sm text-gray-500">ID: {haulier.id}</div>
                                                        </td>
                                                        <td className="px-6 py-4">
                                                            <div className="text-sm text-gray-900">{haulier.email}</div>
                                                            {haulier.phone && (
                                                                <div className="text-sm text-gray-500">{haulier.phone}</div>
                                                            )}
                                                        </td>
                                                        <td className="px-6 py-4">
                                                            <div className="flex flex-wrap gap-1">
                                                                {haulier.transportModes?.map(mode => (
                                                                    <span 
                                                                        key={mode}
                                                                        className={`px-2 py-1 rounded-full text-xs ${
                                                                            mode === 'Road' ? 'bg-green-100 text-green-800' :
                                                                            mode === 'Sea' ? 'bg-blue-100 text-blue-800' :
                                                                            'bg-purple-100 text-purple-800'
                                                                        }`}
                                                                    >
                                                                        {mode}
                                                                    </span>
                                                                ))}
                                                            </div>
                                                        </td>
                                                        <td className="px-6 py-4">
                                                            <div className="flex flex-wrap gap-1">
                                                                {haulier.countries.map(country => (
                                                                    <span 
                                                                        key={country}
                                                                        className="px-2 py-1 bg-gray-100 text-gray-800 rounded-full text-xs"
                                                                    >
                                                                        {country}
                                                                    </span>
                                                                ))}
                                                            </div>
                                                        </td>
                                                        <td className="px-6 py-4">
                                                            <div className="text-sm">
                                                                <div>Total Routes: {stats.totalRoutes}</div>
                                                                <div>Active Routes: {stats.activeRoutes}</div>
                                                                <div>Countries Served: {stats.uniqueCountries}</div>
                                                                <div>Service Types: {stats.services}</div>
                                                            </div>
                                                        </td>
                                                        <td className="px-6 py-4">
                                                            <button
                                                                onClick={() => handleToggleActive(haulier.id, haulier.active)}
                                                                className={`px-2 py-1 rounded-full text-xs ${
                                                                    haulier.active
                                                                        ? 'bg-green-100 text-green-800'
                                                                        : 'bg-red-100 text-red-800'
                                                                }`}
                                                            >
                                                                {haulier.active ? 'Active' : 'Inactive'}
                                                            </button>
                                                        </td>
                                                        <td className="px-6 py-4">
                                                            <div className="flex space-x-2">
                                                                <button
                                                                    onClick={() => {
                                                                        setEditingHaulier(haulier);
                                                                        setShowHaulierForm(true);
                                                                    }}
                                                                    className="text-blue-600 hover:text-blue-800"
                                                                >
                                                                    Edit
                                                                </button>
                                                                <button
                                                                    onClick={() => handleHaulierDelete(haulier.id)}
                                                                    className="text-red-600 hover:text-red-800"
                                                                >
                                                                    Delete
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {activeTab === 'rates' && (
                            <div>
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-xl font-bold">Rates Management</h2>
                                    <button
                                        onClick={() => setShowRateForm(true)}
                                        className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                                    >
                                        Add Rate
                                    </button>
                                </div>

                                {/* Import/Export Section */}
                                <div className="mb-6 p-4 border rounded bg-gray-50">
                                    <h3 className="text-lg font-semibold mb-2">Import/Export Rates</h3>
                                    <div className="flex flex-col sm:flex-row gap-4">
                                        <div>
                                            <input
                                                type="file"
                                                accept=".xlsx,.xls"
                                                onChange={handleRatesImport}
                                                className="mb-2"
                                            />
                                            <div className="text-sm text-gray-600">Import from Excel</div>
                                        </div>
                                        <button
                                            onClick={handleRatesExport}
                                            className="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600"
                                        >
                                            Export to Excel
                                        </button>
                                    </div>
                                    {importStats && (
                                        <div className="mt-4 p-3 bg-blue-50 text-blue-700 rounded">
                                            <h4 className="font-semibold">Import Results:</h4>
                                            <ul className="list-disc pl-5 mt-1">
                                                <li>Total Rows: {importStats.total}</li>
                                                <li>Valid Entries: {importStats.valid}</li>
                                                <li>Invalid Entries: {importStats.invalid}</li>
                                            </ul>
                                        </div>
                                    )}
                                    {importErrors.length > 0 && (
                                        <div className="mt-4 p-4 bg-red-100 text-red-700 rounded">
                                            <h4 className="font-semibold mb-2">Import Errors:</h4>
                                            <ul className="list-disc pl-5">
                                                {importErrors.map((error, index) => (
                                                    <li key={index}>{error}</li>
                                                ))}
                                            </ul>
                                        </div>
                                    )}
                                </div>

                                {/* Rate Filters */}
                                <div className="mb-6 p-4 border rounded">
                                    <h3 className="text-lg font-semibold mb-4">Filter Rates</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4">
                                        <select
                                            className="p-2 border rounded"
                                            value={rateFilters.haulier}
                                            onChange={e => setRateFilters({...rateFilters, haulier: e.target.value})}
                                        >
                                            <option value="">All Hauliers</option>
                                            {hauliers.map(h => (
                                                <option key={h.id} value={h.id}>{h.name}</option>
                                            ))}
                                        </select>
                                        <select
                                            className="p-2 border rounded"
                                            value={rateFilters.transportMode}
                                            onChange={e => setRateFilters({...rateFilters, transportMode: e.target.value})}
                                        >
                                            <option value="">All Transport Modes</option>
                                            <option value="Road">Road</option>
                                            <option value="Sea">Sea</option>
                                            <option value="Air">Air</option>
                                        </select>
                                        <select
                                            className="p-2 border rounded"
                                            value={rateFilters.collectionCountry}
                                            onChange={e => setRateFilters({...rateFilters, collectionCountry: e.target.value})}
                                        >
                                            <option value="">All Collection Countries</option>
                                            {allowedCountries.map(country => (
                                                <option key={country} value={country}>{country}</option>
                                            ))}
                                        </select>
                                        <select
                                            className="p-2 border rounded"
                                            value={rateFilters.deliveryCountry}
                                            onChange={e => setRateFilters({...rateFilters, deliveryCountry: e.target.value})}
                                        >
                                            <option value="">All Delivery Countries</option>
                                            {allowedCountries.map(country => (
                                                <option key={country} value={country}>{country}</option>
                                            ))}
                                        </select>
                                        <select
                                            className="p-2 border rounded"
                                            value={rateFilters.deliveryType}
                                            onChange={e => setRateFilters({...rateFilters, deliveryType: e.target.value})}
                                        >
                                            <option value="">All Delivery Types</option>
                                            <option value="STD">Standard</option>
                                            <option value="EXP">Express</option>
                                            <option value="ADR">ADR</option>
                                            <option value="TEMP">Temperature Controlled</option>
                                        </select>
                                    </div>
                                </div>
                                
                                {/* Rates Table */}
                                <div className="overflow-x-auto" style={{ maxWidth: '100vw' }}>
                                    <table className="w-full whitespace-nowrap">
                                        <thead className="bg-gray-50">
                                            <tr>
                                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Haulier & Route
                                                </th>
                                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Transport Details
                                                </th>
                                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-[150px]">
                                                    Total Price Info
                                                </th>
                                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-[150px]">
                                                    Additional Charges
                                                </th>
                                                {Array.from({ length: 24 }, (_, i) => i + 1).map(num => (
                                                    <th key={num} className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider min-w-[80px]">
                                                        {num} {num === 1 ? 'Pallet' : 'Pallets'}
                                                    </th>
                                                ))}
                                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Actions
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody className="bg-white divide-y divide-gray-200">
                                            {filterRates(rates).map(rate => (
                                    <tr key={rate.id} className="hover:bg-gray-50">
                                        <td className="px-6 py-4">
                                            <div className="text-sm">
                                                <div className="font-medium text-gray-900 mb-1">
                                                    {getHaulierNameById(rate.haulierId)}
                                                </div>
                                                <div>From: {rate.collection?.country || rate.collectionCountry} - {rate.collection?.postcode || rate.collectionPostcode}</div>
                                                <div>To: {rate.delivery?.country || rate.deliveryCountry} - {rate.delivery?.postcode || rate.deliveryPostcode}</div>
                                                <div className="text-xs text-gray-500 mt-1">
                                                    Valid until: {formatDate(rate.validUntil || rate.priceValidity)}
                                                </div>
                                            </div>
                                        </td>
                                        <td className="px-6 py-4">
                                            <div className="text-sm">
                                                <div className="flex items-center gap-2">
                                                    <span className={`px-2 py-1 rounded-full text-xs ${
                                                        rate.transportMode === 'Road' ? 'bg-green-100 text-green-800' :
                                                        rate.transportMode === 'Sea' ? 'bg-blue-100 text-blue-800' :
                                                        'bg-purple-100 text-purple-800'
                                                    }`}>
                                                        {rate.transportMode}
                                                    </span>
                                                    {rate.containerType && (
                                                        <span className="px-2 py-1 bg-gray-100 rounded-full text-xs">
                                                            {rate.containerType}
                                                        </span>
                                                    )}
                                                    {rate.getAllPalletRates && (
                                                        <span className="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs">
                                                            All Pallets (1-24)
                                                        </span>
                                                    )}
                                                </div>
                                                <div className="mt-1">{rate.weightBucket}</div>
                                                <div>{rate.deliveryType}</div>
                                                <div>{rate.incoterms}</div>
                                            </div>
                                        </td>
                                        <td className="px-6 py-4 min-w-[150px]">
                                            <div className="text-sm">
                    {/* Rate Table Columns */}
                    <td className="px-6 py-4 min-w-[150px]">
                        <div className="text-sm">
                            {/* Full Truck Load Price */}
                            {(rate.isFullTruckLoad || rate.loadType === 'Full Truck Load') && (
                                <div className="font-medium">
                                    {formatCurrency(
                                        (rate.fullTruckLoadPrice || 0) + 
                                        (rate.fixedRateSurcharges || 0) + 
                                        ((rate.fullTruckLoadPrice || 0) * (rate.percentSurcharge || 0) / 100), 
                                        rate.currency
                                    )}
                                </div>
                            )}
                            
                            {/* Container Price */}
                            {rate.transportMode === 'Sea' && rate.containerType && (
                                <div className="font-medium">
                                    {rate.rates && rate.rates[rate.containerType] ? (
                                        formatCurrency(
                                            rate.rates[rate.containerType].total || 
                                            ((rate.rates[rate.containerType].rate || 0) + 
                                            (rate.fixedRateSurcharges || 0) + 
                                            ((rate.rates[rate.containerType].rate || 0) * (rate.percentSurcharge || 0) / 100)),
                                            rate.currency
                                        )
                                    ) : 'Price not set'}
                                </div>
                            )}
                                                
                                                {/* Single Rate (from new tender format) */}
                                                {rate.rates?.['Rate']?.total && (
                                                    <div className="font-medium">
                                                        {formatCurrency(rate.rates['Rate'].total, rate.currency)}
                                                    </div>
                                                )}
                                                
                                                {/* Air Freight Rate */}
                                                {rate.transportMode === 'Air' && rate.airFreightPrice && (
                                                    <div className="font-medium">
                                                        {formatCurrency(
                                                            (rate.airFreightPrice || 0) + 
                                                            (rate.fixedRateSurcharges || 0) + 
                                                            ((rate.airFreightPrice || 0) * (rate.percentSurcharge || 0) / 100),
                                                            rate.currency
                                                        )}
                                                    </div>
                                                )}
                                                
                                                {/* Regular Pallet Rates Display */}
                                                {(!rate.isFullTruckLoad && !rate.containerType && rate.transportMode !== 'Air') && (
                                                    <div className="font-medium">
                                                        {rate.pallets && (rate.rates?.[`${rate.pallets} Pallet${rate.pallets > 1 ? 's' : ''}`]?.total || rate.prices?.[rate.pallets]) ? 
                                                            formatCurrency(
                                                                rate.rates?.[`${rate.pallets} Pallet${rate.pallets > 1 ? 's' : ''}`]?.total ||
                                                                (rate.prices[rate.pallets] + 
                                                                (rate.fixedRateSurcharges || 0) + 
                                                                (rate.prices[rate.pallets] * (rate.percentSurcharge || 0) / 100)),
                                                                rate.currency
                                                            ) : 'Price not set'
                                                        }
                                                    </div>
                                                )}
                                                
                                                {/* Weight-based Rate */}
                                                {rate.weightBasedPrice && (
                                                    <div className="font-medium">
                                                        {formatCurrency(
                                                            (rate.weightBasedPrice || 0) + 
                                                            (rate.fixedRateSurcharges || 0) + 
                                                            ((rate.weightBasedPrice || 0) * (rate.percentSurcharge || 0) / 100),
                                                            rate.currency
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                        </td>
                                        <td className="px-6 py-4 min-w-[150px]">
                                            <div className="text-sm space-y-1">
                                                {rate.fixedRateSurcharges > 0 && (
                                                    <div>
                                                        Fixed: <span className="font-medium">{formatCurrency(rate.fixedRateSurcharges || 0, rate.currency)}</span>
                                                    </div>
                                                )}
                                                {rate.percentSurcharge > 0 && (
                                                    <div>
                                                        Surcharge: <span className="font-medium">{rate.percentSurcharge}%</span>
                                                    </div>
                                                )}
                                                <div>
                                                    Customs: {rate.includeCustomsClearance ? (
                                                        <span className="text-green-600 font-medium">Included</span>
                                                    ) : (
                                                        <span className="text-red-600 font-medium">Not Included</span>
                                                    )}
                                                </div>
                                            </div>
                                        </td>
                                        {/* Pallet Price Columns */}
                                        {Array.from({ length: 24 }, (_, i) => i + 1).map(num => (
                                            <td key={num} className="px-4 py-4 text-center min-w-[80px]">
                                                {rate.rates?.[`${num} Pallet${num > 1 ? 's' : ''}`]?.total ? (
                                                    // New format from tender submissions
                                                    <div className="font-medium">
                                                        {formatCurrency(rate.rates[`${num} Pallet${num > 1 ? 's' : ''}`].total, rate.currency)}
                                                    </div>
                                                ) : rate.prices?.[num] ? (
                                                    // Legacy format 
                                                    <div className="font-medium">
                                                        {formatCurrency(
                                                            rate.prices[num] + 
                                                            (rate.fixedRateSurcharges || 0) + 
                                                            (rate.prices[num] * (rate.percentSurcharge || 0) / 100),
                                                            rate.currency
                                                        )}
                                                    </div>
                                                ) : (
                                                    <span className="text-gray-400">-</span>
                                                )}
                                            </td>
                                        ))}
                                        <td className="px-6 py-4">
                                            <div className="flex flex-col space-y-2">
                                                <button
                                                    onClick={() => {
                                                        setEditingRate(rate);
                                                        setShowRateForm(true);
                                                    }}
                                                    className="text-blue-600 hover:text-blue-800 text-sm"
                                                >
                                                    Edit
                                                </button>
                                                <button
                                                    onClick={() => handleRateDelete(rate.id)}
                                                    className="text-red-600 hover:text-red-800 text-sm"
                                                >
                                                    Delete
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                    {/* Haulier Form Modal */}
                    {showHaulierForm && (
                        <div className="modal-overlay">
                            <div className="modal-content max-w-2xl">
                                <div className="flex justify-between items-start mb-4">
                                    <h3 className="text-lg font-semibold">
                                        {editingHaulier ? 'Edit Haulier' : 'Add New Haulier'}
                                    </h3>
                                    <button 
                                        onClick={() => {
                                            setShowHaulierForm(false);
                                            setEditingHaulier(null);
                                        }}
                                        className="text-gray-400 hover:text-gray-600"
                                    >
                                        ×
                                    </button>
                                </div>
                                
                                <form onSubmit={handleHaulierSubmit} className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Company Name *</label>
                                        <input 
                                            name="name"
                                            type="text"
                                            required
                                            defaultValue={editingHaulier?.name}
                                            className="w-full p-2 border rounded"
                                        />
                                    </div>
                                    
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Email Address *</label>
                                            <input 
                                                name="email"
                                                type="email"
                                                required
                                                defaultValue={editingHaulier?.email}
                                                className="w-full p-2 border rounded"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Phone Number</label>
                                            <input 
                                                name="phone"
                                                type="tel"
                                                defaultValue={editingHaulier?.phone}
                                                className="w-full p-2 border rounded"
                                            />
                                        </div>
                                    </div>
                    
                                    {/* Transport Modes Section */}
                                    <div>
                                        <label className="block text-sm font-medium mb-2">Transport Modes *</label>
                                        <div className="space-y-2">
                                            <label className="flex items-center">
                                                <input 
                                                    type="checkbox" 
                                                    name="transportModes" 
                                                    value="Road"
                                                    defaultChecked={editingHaulier?.transportModes?.includes('Road')}
                                                    className="mr-2"
                                                />
                                                Road Transport
                                            </label>
                                            <label className="flex items-center">
                                                <input 
                                                    type="checkbox" 
                                                    name="transportModes" 
                                                    value="Sea"
                                                    defaultChecked={editingHaulier?.transportModes?.includes('Sea')}
                                                    className="mr-2"
                                                />
                                                Sea Freight
                                            </label>
                                            <label className="flex items-center">
                                                <input 
                                                    type="checkbox" 
                                                    name="transportModes" 
                                                    value="Air"
                                                    defaultChecked={editingHaulier?.transportModes?.includes('Air')}
                                                    className="mr-2"
                                                />
                                                Air Freight
                                            </label>
                                        </div>
                                    </div>
                    
                                    <div>
                                        <label className="block text-sm font-medium mb-2">Operating Countries *</label>
                                        <select
                                            multiple
                                            name="operatingCountries"
                                            required
                                            defaultValue={editingHaulier?.countries || []}
                                            className="w-full p-2 border rounded h-40"
                                        >
                                            {allowedCountries.map(country => (
                                                <option key={country} value={country}>
                                                    {country}
                                                </option>
                                            ))}
                                        </select>
                                        <small className="text-gray-500">
                                            Hold Ctrl/Cmd to select multiple countries
                                        </small>
                                    </div>
                    
                                    <div>
                                        <label className="block text-sm font-medium mb-2">Services Offered</label>
                                        <div className="space-y-2">
                                            <label className="flex items-center">
                                                <input 
                                                    type="checkbox" 
                                                    name="services" 
                                                    value="ADR"
                                                    defaultChecked={editingHaulier?.services?.includes('ADR')}
                                                    className="mr-2"
                                                />
                                                ADR/Hazardous Goods
                                            </label>
                                            <label className="flex items-center">
                                                <input 
                                                    type="checkbox" 
                                                    name="services" 
                                                    value="TEMP"
                                                    defaultChecked={editingHaulier?.services?.includes('TEMP')}
                                                    className="mr-2"
                                                />
                                                Temperature Controlled
                                            </label>
                                            <label className="flex items-center">
                                                <input 
                                                    type="checkbox" 
                                                    name="services" 
                                                    value="EXPRESS"
                                                    defaultChecked={editingHaulier?.services?.includes('EXPRESS')}
                                                    className="mr-2"
                                                />
                                                Express Delivery
                                            </label>
                                        </div>
                                    </div>
                    
                                    <div>
                                        <label className="block text-sm font-medium mb-2">Certifications</label>
                                        <div className="space-y-2">
                                            <label className="flex items-center">
                                                <input 
                                                    type="checkbox" 
                                                    name="certifications" 
                                                    value="ISO9001"
                                                    defaultChecked={editingHaulier?.certifications?.includes('ISO9001')}
                                                    className="mr-2"
                                                />
                                                ISO 9001
                                            </label>
                                            <label className="flex items-center">
                                                <input 
                                                    type="checkbox" 
                                                    name="certifications" 
                                                    value="GDP"
                                                    defaultChecked={editingHaulier?.certifications?.includes('GDP')}
                                                    className="mr-2"
                                                />
                                                GDP Compliant
                                            </label>
                                        </div>
                                    </div>
                    
                                    <div className="flex gap-2">
                                        <button 
                                            type="submit"
                                            className="flex-1 azelis-blue text-white p-2 rounded hover:bg-blue-700"
                                        >
                                            {editingHaulier ? 'Update' : 'Add'} Haulier
                                        </button>
                                        <button 
                                            type="button"
                                            onClick={() => {
                                                setShowHaulierForm(false);
                                                setEditingHaulier(null);
                                            }}
                                            className="flex-1 bg-gray-200 text-gray-700 p-2 rounded hover:bg-gray-300"
                                        >
                                            Cancel
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                     {/* Rate Details Modal */}
                {showRateDetails && selectedRate && (
                    <div className="modal-overlay">
                        <div className="modal-content max-w-4xl">
                            <div className="flex justify-between items-start mb-4">
                                <h3 className="text-lg font-semibold">Rate Details</h3>
                                <button 
                                    onClick={() => {
                                        setShowRateDetails(false);
                                        setSelectedRate(null);
                                    }}
                                    className="text-gray-400 hover:text-gray-600"
                                >
                                    ×
                                </button>
                            </div>
                
                            <div className="space-y-6">
                                {/* Basic Info */}
                                <div>
                                    <h4 className="font-medium mb-2">Basic Information</h4>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <p><strong>Quote ID:</strong> {selectedRate.quoteId || 'N/A'}</p>
                                            <p><strong>Haulier:</strong> {selectedRate.haulierName || 'N/A'}</p>
                                            <p><strong>Currency:</strong> {selectedRate.currency || 'N/A'}</p>
                                            <p><strong>Valid Until:</strong> {selectedRate.validUntil ? new Date(selectedRate.validUntil).toLocaleDateString() : 'N/A'}</p>
                                        </div>
                                        <div>
                                            <p><strong>Transit Time:</strong> {selectedRate.transitTime || 'N/A'} days</p>
                                            <p><strong>Fixed Surcharges:</strong> {formatCurrency(selectedRate.fixedRateSurcharges || 0, selectedRate.currency)}</p>
                                            <p><strong>Percent Surcharge:</strong> {selectedRate.percentSurcharge || 0}%</p>
                                        </div>
                                    </div>
                                </div>
                
                        {/* Pricing Details */}
                        <div>
                            <h4 className="font-medium mb-2">Pricing Information</h4>
                            <div className="grid grid-cols-3 gap-4">
                                {selectedRate.isFullTruckLoad ? (
                                    <div className="p-3 bg-gray-50 rounded">
                                        <p className="font-medium">Full Truck Load Price</p>
                                        <p>Base Rate: {formatCurrency(selectedRate.fullTruckLoadPrice || 0, selectedRate.currency)}</p>
                                        <p>Total: {formatCurrency(
                                            (selectedRate.fullTruckLoadPrice || 0) + 
                                            (selectedRate.fixedRateSurcharges || 0) + 
                                            ((selectedRate.fullTruckLoadPrice || 0) * (selectedRate.percentSurcharge || 0) / 100), 
                                            selectedRate.currency
                                        )}</p>
                                    </div>
                                ) : selectedRate.rates ? (
                                    Object.entries(selectedRate.rates).map(([key, value]) => (
                                        <div key={key} className="p-3 bg-gray-50 rounded">
                                            <p className="font-medium">{key}</p>
                                            <p>Base Rate: {formatCurrency(value.rate || 0, selectedRate.currency)}</p>
                                            <p>Total: {formatCurrency(value.total || 0, selectedRate.currency)}</p>
                                        </div>
                                    ))
                                ) : (
                                    // Handle legacy format or different rate structure
                                    Object.entries(selectedRate.prices || {}).map(([pallets, price]) => (
                                        <div key={pallets} className="p-3 bg-gray-50 rounded">
                                            <p className="font-medium">{pallets} Pallet{parseInt(pallets) > 1 ? 's' : ''}</p>
                                            <p>Base Rate: {formatCurrency(price || 0, selectedRate.currency)}</p>
                                            <p>Total: {formatCurrency(
                                                (price || 0) + 
                                                (selectedRate.fixedRateSurcharges || 0) + 
                                                ((price || 0) * (selectedRate.percentSurcharge || 0) / 100), 
                                                selectedRate.currency
                                            )}</p>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>
                
                                {/* Additional Details */}
                                <div>
                                    <h4 className="font-medium mb-2">Additional Details</h4>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <p><strong>Hide Documents:</strong> {selectedRate.hideDocuments ? 'Yes' : 'No'}</p>
                                            <p><strong>Include Customs:</strong> {selectedRate.includeCustomsClearance ? 'Yes' : 'No'}</p>
                                            <p><strong>Peak Season:</strong> {selectedRate.isPeakSeason ? 'Yes' : 'No'}</p>
                                            {selectedRate.isPeakSeason && 
                                                <p><strong>Peak Details:</strong> {selectedRate.peakSeasonDetails}</p>}
                                        </div>
                                        <div>
                                            <p><strong>Urgency:</strong> {selectedRate.urgency || 'N/A'}</p>
                                            <p><strong>Preferred Delivery:</strong> {selectedRate.preferredDeliveryDate || 'N/A'}</p>
                                            <p><strong>Submission Date:</strong> {selectedRate.submittedAt ? 
                                                selectedRate.submittedAt.toDate().toLocaleDateString() : 'N/A'}</p>
                                        </div>
                                    </div>
                                </div>
                
                                {/* Waypoints */}
                                {selectedRate.waypoints && selectedRate.waypoints.length > 0 && (
                                    <div>
                                        <h4 className="font-medium mb-2">Waypoints</h4>
                                        <div className="grid grid-cols-2 gap-4">
                                            {selectedRate.waypoints.map((waypoint, index) => (
                                                <div key={index} className="p-2 bg-gray-50 rounded">
                                                    <p className="font-medium">Waypoint {index + 1}</p>
                                                    <p>Country: {waypoint.country}</p>
                                                    <p>Postcode: {waypoint.postcode}</p>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                )}

                        {/* Rate Form Modal */}
                        {showRateForm && (
                            <RateFormModal
                                hauliers={hauliers}
                                editingRate={editingRate}
                                setShowRateForm={setShowRateForm}
                                setEditingRate={setEditingRate}
                                getHaulierNameById={getHaulierNameById}
                            />
                        )}
                    </div>
                </div>
            );
        };

        // RateFormModal Component
        const RateFormModal = ({ hauliers, editingRate, setShowRateForm, setEditingRate, getHaulierNameById }) => {
            const [transportMode, setTransportMode] = React.useState(editingRate?.transportMode || '');
            const [loadType, setLoadType] = React.useState(editingRate?.isFullTruckLoad ? 'ftl' : 'pl');
            const [palletPrices, setPalletPrices] = React.useState(editingRate?.prices || {});

            const handleTransportModeChange = (e) => {
                setTransportMode(e.target.value);
                // Reset dependent fields when transport mode changes
                if (e.target.value !== 'Sea') {
                    // Reset container type and volume
                }
                if (e.target.value !== 'Air') {
                    // Reset air weight and volume
                }
            };

            const handleLoadTypeChange = (e) => {
                setLoadType(e.target.value);
                // Reset pricing fields when load type changes
            };

            const handlePalletPriceChange = (pallet, value) => {
                setPalletPrices(prev => ({
                    ...prev,
                    [pallet]: value
                }));
            };

            return (
                <div className="modal-overlay">
                    <div className="modal-content max-w-4xl">
                        <div className="flex justify-between items-start mb-4">
                            <h3 className="text-lg font-semibold">
                                {editingRate ? 'Edit Rate' : 'Add New Rate'}
                            </h3>
                            <button 
                                onClick={() => {
                                    setShowRateForm(false);
                                    setEditingRate(null);
                                }}
                                className="text-gray-400 hover:text-gray-600"
                            >
                                ×
                            </button>
                        </div>
                                        
                        <form onSubmit={handleRateSubmit} className="space-y-6">
                            {/* Route Details */}
                            <div>
                                <h4 className="text-md font-semibold mb-2">Route Details</h4>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Collection Country *</label>
                                        <select
                                            name="collectionCountry"
                                            required
                                            defaultValue={editingRate?.collectionCountry || ''}
                                            className="w-full p-2 border rounded"
                                        >
                                            <option value="">Select Country</option>
                                            {allowedCountries.map(country => (
                                                <option key={country} value={country}>{country}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Collection Postcode</label>
                                        <input 
                                            name="collectionPostcode"
                                            type="text"
                                            defaultValue={editingRate?.collectionPostcode}
                                            className="w-full p-2 border rounded"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Delivery Country *</label>
                                        <select
                                            name="deliveryCountry"
                                            required
                                            defaultValue={editingRate?.deliveryCountry || ''}
                                            className="w-full p-2 border rounded"
                                        >
                                            <option value="">Select Country</option>
                                            {allowedCountries.map(country => (
                                                <option key={country} value={country}>{country}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Delivery Postcode</label>
                                        <input 
                                            name="deliveryPostcode"
                                            type="text"
                                            defaultValue={editingRate?.deliveryPostcode}
                                            className="w-full p-2 border rounded"
                                        />
                                    </div>
                                </div>
                            </div>

                            {/* Transport Details */}
                            <div>
                                <h4 className="text-md font-semibold mb-2">Transport Details</h4>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Transport Mode *</label>
                                        <select
                                            name="transportMode"
                                            required
                                            value={transportMode}
                                            onChange={handleTransportModeChange}
                                            className="w-full p-2 border rounded"
                                        >
                                            <option value="">Select Mode</option>
                                            <option value="Road">Road</option>  
                                            <option value="Sea">Sea</option>
                                            <option value="Air">Air</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Weight Bucket *</label>
                                        <select
                                            name="weightBucket"
                                            required
                                            defaultValue={editingRate?.weightBucket || ''}
                                            className="w-full p-2 border rounded"
                                        >
                                            <option value="">Select Bucket</option>
                                            <option value="<500kg">&lt;500kg</option>
                                            <option value="500kg-1ton">500kg - 1 ton</option>
                                            <option value="1ton-5tons">1 ton - 5 tons</option>  
                                            <option value=">5tons">&gt;5 tons</option>
                                        </select>  
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Incoterms *</label>
                                        <select
                                            name="incoterms"
                                            required
                                            defaultValue={editingRate?.incoterms || ''}
                                            className="w-full p-2 border rounded"  
                                        >
                                            <option value="">Select Incoterms</option>
                                            <option value="EXW">EXW</option>
                                            <option value="FCA">FCA</option>
                                            <option value="CPT">CPT</option>
                                            <option value="CIP">CIP</option>
                                            <option value="DAP">DAP</option>  
                                            <option value="DPU">DPU</option>
                                            <option value="DDP">DDP</option>
                                            <option value="FAS">FAS</option>
                                            <option value="FOB">FOB</option>
                                            <option value="CFR">CFR</option>
                                            <option value="CIF">CIF</option>  
                                        </select>
                                    </div>  
                                </div>
                            </div>

                            {/* Pricing and Validity */}
                            <div>
                                <h4 className="text-md font-semibold mb-2">Pricing and Validity</h4>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>  
                                        <label className="block text-sm font-medium mb-1">Price Validity *</label>
                                        <input 
                                            name="priceValidity"
                                            type="date"
                                            required
                                            defaultValue={editingRate?.priceValidity}
                                            className="w-full p-2 border rounded"  
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Currency *</label>
                                        <select  
                                            name="currency"
                                            required
                                            defaultValue={editingRate?.currency || 'GBP'}
                                            className="w-full p-2 border rounded"
                                        >
                                            <option value="GBP">GBP</option>
                                            <option value="EUR">EUR</option>
                                            <option value="USD">USD</option>
                                        </select>
                                    </div>
                                    <div>    
                                        <label className="block text-sm font-medium mb-1">Load Type *</label>
                                        <select
                                            name="loadType"  
                                            required
                                            value={loadType}
                                            onChange={handleLoadTypeChange}
                                            className="w-full p-2 border rounded"
                                        >
                                            <option value="pl">Partial Load</option>
                                            <option value="ftl">Full Truck Load</option>   
                                        </select>
                                    </div>
                                </div>  
                            </div>

                            {/* Load Type Pricing */}  
                            <div>
                                <h4 className="text-md font-semibold mb-2">Load Pricing</h4>
                                {loadType === 'ftl' ? (
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Full Truck Load Price *</label>
                                        <input   
                                            name="ftlPrice"
                                            type="number"
                                            step="0.01"
                                            required={loadType === 'ftl'}  
                                            defaultValue={editingRate?.fullTruckLoadPrice}
                                            className="w-full p-2 border rounded"
                                        />  
                                    </div>
                                ) : (  
                                    <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">  
                                        {Array.from({ length: 24 }, (_, i) => i + 1).map(pallet => (
                                            <div key={pallet}>
                                                <label className="block text-sm font-medium mb-1">{pallet} Pallet{pallet > 1 ? 's' : ''}</label>
                                                <input   
                                                    name={`${pallet}Pallet`}
                                                    type="number" 
                                                    step="0.01"
                                                    value={palletPrices[pallet] || ''}
                                                    onChange={(e) => handlePalletPriceChange(pallet, e.target.value)}
                                                    className="w-full p-2 border rounded"  
                                                />
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>  

                            {/* Haulier Selection */}
                            <div>
                                <label className="block text-sm font-medium mb-1">Haulier *</label>
                                <select   
                                    name="haulierId"
                                    required
                                    defaultValue={editingRate?.haulierId || ''}
                                    className="w-full p-2 border rounded"
                                >
                                    <option value="">Select Haulier</option>
                                    {hauliers.map(haulier => (  
                                        <option key={haulier.id} value={haulier.id}>{haulier.name}</option>
                                    ))} 
                                </select>  
                            </div>

                            {/* Service and Additional Details */}
                            <div>  
                                <h4 className="text-md font-semibold mb-2">Service & Additional Details</h4>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Delivery Type</label> 
                                        <select
                                            name="deliveryType"
                                            defaultValue={editingRate?.deliveryType || 'STD'}
                                            className="w-full p-2 border rounded"
                                        >
                                            <option value="STD">Standard</option>
                                            <option value="EXP">Express</option>  
                                            <option value="ADR">ADR</option>
                                            <option value="TEMP">Temperature Controlled</option>
                                        </select>  
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Transit Time (Days)</label>
                                        <input   
                                            name="transitTime"
                                            type="number"
                                            min="1"
                                            defaultValue={editingRate?.transitTime}
                                            className="w-full p-2 border rounded"
                                        />
                                    </div>  
                                    <div>  
                                        <label className="block text-sm font-medium mb-1">Services</label> 
                                        <select
                                            name="services"  
                                            multiple
                                            defaultValue={editingRate?.services || []}
                                            className="w-full p-2 border rounded"
                                        >
                                            <option value="Tracking">Tracking</option>
                                            <option value="Insurance">Insurance</option>
                                            <option value="Customs">Customs</option>  
                                        </select>
                                    </div>
                                </div>
                            </div>

                            {/* Additional Fields */}
                            {(transportMode === 'Sea' || (editingRate && editingRate.transportMode === 'Sea')) && (
                                <div>
                                    <label className="block text-sm font-medium mb-1">Container Type</label>
                                    <select
                                        name="containerType"
                                        defaultValue={editingRate?.containerType || ''}
                                        className="w-full p-2 border rounded"
                                    >
                                        <option value="">Select Container</option>
                                        <option value="20ft">20ft</option>
                                        <option value="40ft">40ft</option>
                                        <option value="40ft HC">40ft HC</option>
                                        <option value="45ft">45ft</option>
                                        <option value="LCL">LCL</option>
                                    </select>
                                </div>
                            )}

                            {(transportMode === 'Air' || (editingRate && editingRate.transportMode === 'Air')) && (
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Air Weight (Kg)</label>
                                        <input
                                            name="airWeight" 
                                            type="number"
                                            step="0.1"
                                            defaultValue={editingRate?.airWeight}
                                            className="w-full p-2 border rounded"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Volume (CBM)</label>
                                        <input
                                            name="volume"
                                            type="number" 
                                            step="0.1"
                                            defaultValue={editingRate?.volume}  
                                            className="w-full p-2 border rounded"
                                        />  
                                    </div>
                                </div>  
                            )}

                            {/* Form Actions */}  
                            <div className="flex gap-2">
                                <button   
                                    type="submit"
                                    className="flex-1 bg-blue-500 text-white p-2 rounded hover:bg-blue-600"  
                                >
                                    {editingRate ? 'Update' : 'Add'} Rate  
                                </button>
                                <button
                                    type="button" 
                                    onClick={() => {
                                        setShowRateForm(false); 
                                        setEditingRate(null);  
                                    }}
                                    className="flex-1 bg-gray-200 text-gray-700 p-2 rounded hover:bg-gray-300"
                                >
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>  
                </div>
            );
        };

        // Render the HaulierManagement component to the DOM
        ReactDOM.render(<HaulierManagement />, document.getElementById('root'));
    </script>
</body>
</html>

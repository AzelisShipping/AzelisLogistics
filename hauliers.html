import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc } from 'firebase/firestore';

// Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyDiIRLwLeMAf1VZbZ7ygvGDu-gZH6sA424",
  authDomain: "azelislogistics.firebaseapp.com",
  projectId: "azelislogistics",
  storageBucket: "azelislogistics.firebasestorage.app",
  messagingSenderId: "13102382958",
  appId: "1:13102382958:web:82a3324843432519cb8b7f",
  measurementId: "G-Q6JNN8DHJQ"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const HaulierManagement = () => {
  const [activeTab, setActiveTab] = useState('hauliers');
  const [hauliers, setHauliers] = useState([]);
  const [rates, setRates] = useState([]);
  const [showForm, setShowForm] = useState(false);
  const [editingHaulier, setEditingHaulier] = useState(null);
  const [loading, setLoading] = useState(true);

  const countries = ["UK", "BEL", "FRA", "GER", "NLD", "ESP", "ITA"];

  // Fetch data from Firebase on component mount
  useEffect(() => {
    const fetchData = async () => {
      try {
        // Fetch hauliers
        const hauliersSnapshot = await getDocs(collection(db, 'hauliers'));
        const hauliersData = hauliersSnapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        setHauliers(hauliersData);

        // Fetch rates
        const ratesSnapshot = await getDocs(collection(db, 'rates'));
        const ratesData = ratesSnapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        setRates(ratesData);
      } catch (error) {
        console.error('Error fetching data:', error);
      } finally {
        setLoading(false);
      }
    };

    fetchData();
  }, []);

  // Handle haulier form submission
  const handleHaulierSubmit = async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const selectedCountries = countries.filter(country => 
      formData.get(`country-${country}`)
    );
    
    const haulierData = {
      name: formData.get('name'),
      email: formData.get('email'),
      countries: selectedCountries,
      active: true
    };

    try {
      if (editingHaulier) {
        // Update existing haulier
        await updateDoc(doc(db, 'hauliers', editingHaulier.id), haulierData);
        setHauliers(hauliers.map(h => 
          h.id === editingHaulier.id ? {...haulierData, id: editingHaulier.id} : h
        ));
      } else {
        // Add new haulier
        const docRef = await addDoc(collection(db, 'hauliers'), haulierData);
        setHauliers([...hauliers, { ...haulierData, id: docRef.id }]);
      }
      
      setShowForm(false);
      setEditingHaulier(null);
    } catch (error) {
      console.error('Error saving haulier:', error);
      alert('Error saving haulier. Please try again.');
    }
  };

  // Handle rate import from Excel
  const handleRatesImport = async (event) => {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = async (e) => {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { defval: '' });

        // Process and save each rate to Firebase
        for (const row of jsonData) {
          const rateData = {
            collectionCountry: row['Collection Country'] || '',
            deliveryCountry: row['Delivery Country'] || '',
            deliveryType: row['Delivery Type'] || 'STD',
            priceValidity: row['Price Validity'] || '2024-12-31',
            isFullTruckLoad: row['Is Full Truck Load']?.toLowerCase() === 'yes',
            fullTruckLoadPrice: row['Full Truck Load Price'] ? parseFloat(row['Full Truck Load Price']) : null,
            prices: {
              1: row['1 Pallet'] ? parseFloat(row['1 Pallet']) : null,
              2: row['2 Pallets'] ? parseFloat(row['2 Pallets']) : null,
              3: row['3 Pallets'] ? parseFloat(row['3 Pallets']) : null,
              4: row['4 Pallets'] ? parseFloat(row['4 Pallets']) : null,
              5: row['5 Pallets'] ? parseFloat(row['5 Pallets']) : null,
            }
          };

          await addDoc(collection(db, 'rates'), rateData);
        }

        // Refresh rates data
        const ratesSnapshot = await getDocs(collection(db, 'rates'));
        const ratesData = ratesSnapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        setRates(ratesData);

        alert('Rates imported successfully!');
      } catch (error) {
        console.error('Error importing rates:', error);
        alert('Failed to import rates. Please check the file format.');
      }
    };

    reader.readAsArrayBuffer(file);
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className="text-lg">Loading...</div>
      </div>
    );
  }

  return (
    <div className="max-w-7xl mx-auto p-4">
      <div className="bg-white rounded-lg shadow-lg p-6">
        {/* Tabs */}
        <div className="flex border-b mb-4">
          <button
            onClick={() => setActiveTab('hauliers')}
            className={`mr-4 pb-2 ${activeTab === 'hauliers' ? 'border-b-2 border-blue-600' : ''}`}
          >
            Hauliers
          </button>
          <button
            onClick={() => setActiveTab('rates')}
            className={`pb-2 ${activeTab === 'rates' ? 'border-b-2 border-blue-600' : ''}`}
          >
            Rates
          </button>
        </div>

        {/* Rest of your existing UI components */}
        {/* ... (Keep your existing JSX for tables and forms) ... */}
      </div>
    </div>
  );
};

export default HaulierManagement;

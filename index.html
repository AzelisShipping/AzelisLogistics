<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azelis Shipping Calculator</title>
    <link rel="icon" href="https://www.azelis.com/themes/custom/azelis_theme/favicon.ico" type="image/x-icon">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>
        (function() {
            emailjs.init('ZU_ZvcimnTfLR22wF');
        })();
    </script>
    <script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        .azelis-blue { background-color: #003087; }
    </style>
</head>
<body class="bg-gray-50">
    <header class="azelis-blue text-white p-4">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <img src="https://www.azelis.com/themes/custom/azelis_theme/logo.svg" alt="Azelis Logo" class="h-8" />
                <h1 class="text-xl font-bold">Shipping Calculator</h1>
            </div>
        </div>
    </header>

    <div id="root"></div>

    <script type="text/babel">
        const App = () => {
            const [collection, setCollection] = React.useState({ country: '', location: '', postcode: '' });
            const [delivery, setDelivery] = React.useState({ country: '', location: '', postcode: '' });
            const [pallets, setPallets] = React.useState(1);
            const [deliveryType, setDeliveryType] = React.useState('STD');
            const [price, setPrice] = React.useState(null);
            const [sending, setSending] = React.useState(false);
            const [showQuoteForm, setShowQuoteForm] = React.useState(false);
            const [isFullTruck, setIsFullTruck] = React.useState(false);

            const countries = ["UK", "BEL", "FRA", "GER", "NLD", "ESP", "ITA"];

            const handleSendQuote = async () => {
                setSending(true);
                try {
                    const hauliers = JSON.parse(localStorage.getItem('hauliers') || '[]');
                    const relevantHauliers = hauliers.filter(h => 
                        h.active && 
                        (h.countries.includes(collection.country) || h.countries.includes(delivery.country))
                    );

                    if (relevantHauliers.length === 0) {
                        alert('No active hauliers found for these countries');
                        return;
                    }

                    const emailBody = `
Collection:
Country: ${collection.country}
Location: ${collection.location}
Postcode: ${collection.postcode}

Delivery:
Country: ${delivery.country}
Location: ${delivery.location}
Postcode: ${delivery.postcode}

Shipment Details:
Type: ${isFullTruck ? 'Full Truck Load' : `${pallets} Pallets`}
Delivery Type: ${deliveryType}`;

                    for (const haulier of relevantHauliers) {
                        await emailjs.send(
                            'Azelis_Logistics',
                            'template_qff4wum',
                            {
                                to_email: haulier.email,
                                reply_to: 'greg.michell@azelis.com',
                                subject: `Quote Request: ${collection.country} to ${delivery.country}`,
                                message: emailBody
                            }
                        );
                    }

                    alert('Quotes requested successfully!');
                    setShowQuoteForm(false);
                } catch (error) {
                    console.error('Failed to send emails:', error);
                    alert('Failed to send quote requests. Please try again.');
                } finally {
                    setSending(false);
                }
            };

            const calculatePrice = () => {
                if (collection.country && delivery.country) {
                    const hasRate = Math.random() > 0.5;
                    if (hasRate) {
                        const basePrice = 350 + (Math.random() * 200);
                        setPrice(basePrice * (isFullTruck ? 24 : pallets));
                    } else {
                        setPrice(null);
                        if (confirm('No existing rate found. Request quotes?')) {
                            setShowQuoteForm(true);
                        }
                    }
                }
            };

            return (
                <div className="max-w-4xl mx-auto p-4">
                    <div className="bg-white rounded-lg shadow p-6">
                        {/* Collection Address */}
                        <div className="mb-6">
                            <h2 className="text-lg font-semibold mb-4">Collection Address</h2>
                            <div className="grid grid-cols-3 gap-4">
                                <div>
                                    <label className="block text-sm mb-1">Country</label>
                                    <select 
                                        className="w-full p-2 border rounded"
                                        value={collection.country}
                                        onChange={e => setCollection({...collection, country: e.target.value})}
                                    >
                                        <option value="">Select Country</option>
                                        {countries.map(c => (
                                            <option key={c} value={c}>{c}</option>
                                        ))}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm mb-1">Location</label>
                                    <input 
                                        type="text"
                                        className="w-full p-2 border rounded"
                                        value={collection.location}
                                        onChange={e => setCollection({...collection, location: e.target.value})}
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm mb-1">Postcode</label>
                                    <input 
                                        type="text"
                                        className="w-full p-2 border rounded"
                                        value={collection.postcode}
                                        onChange={e => setCollection({...collection, postcode: e.target.value})}
                                    />
                                </div>
                            </div>
                        </div>

                        {/* Delivery Address */}
                        <div className="mb-6">
                            <h2 className="text-lg font-semibold mb-4">Delivery Address</h2>
                            <div className="grid grid-cols-3 gap-4">
                                <div>
                                    <label className="block text-sm mb-1">Country</label>
                                    <select 
                                        className="w-full p-2 border rounded"
                                        value={delivery.country}
                                        onChange={e => setDelivery({...delivery, country: e.target.value})}
                                    >
                                        <option value="">Select Country</option>
                                        {countries.map(c => (
                                            <option key={c} value={c}>{c}</option>
                                        ))}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm mb-1">Location</label>
                                    <input 
                                        type="text"
                                        className="w-full p-2 border rounded"
                                        value={delivery.location}
                                        onChange={e => setDelivery({...delivery, location: e.target.value})}
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm mb-1">Postcode</label>
                                    <input 
                                        type="text"
                                        className="w-full p-2 border rounded"
                                        value={delivery.postcode}
                                        onChange={e => setDelivery({...delivery, postcode: e.target.value})}
                                    />
                                </div>
                            </div>
                        </div>

                        {/* Shipping Details */}
                        <div className="mb-6">
                            <h2 className="text-lg font-semibold mb-4">Shipping Details</h2>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm mb-1">Type</label>
                                    <select 
                                        className="w-full p-2 border rounded"
                                        value={isFullTruck ? 'full' : 'partial'}
                                        onChange={e => setIsFullTruck(e.target.value === 'full')}
                                    >
                                        <option value="partial">Partial Load</option>
                                        <option value="full">Full Truck</option>
                                    </select>
                                </div>
                                {!isFullTruck && (
                                    <div>
                                        <label className="block text-sm mb-1">Pallets</label>
                                        <input 
                                            type="number"
                                            min="1"
                                            max="24"
                                            className="w-full p-2 border rounded"
                                            value={pallets}
                                            onChange={e => setPallets(parseInt(e.target.value) || 1)}
                                        />
                                    </div>
                                )}
                                <div>
                                    <label className="block text-sm mb-1">Delivery Type</label>
                                    <select
                                        className="w-full p-2 border rounded"
                                        value={deliveryType}
                                        onChange={e => setDeliveryType(e.target.value)}
                                    >
                                        <option value="STD">Standard</option>
                                        <option value="ADR">ADR</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <button
                            onClick={calculatePrice}
                            className="w-full azelis-blue text-white p-3 rounded font-medium hover:opacity-90"
                        >
                            Calculate Price
                        </button>

                        {price && (
                            <div className="mt-4 p-4 bg-green-50 border border-green-200 rounded">
                                <div className="text-xl font-bold text-green-700">
                                    Price: £{price.toFixed(2)}
                                </div>
                            </div>
                        )}
                    </div>

                    {showQuoteForm && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-lg p-6 max-w-md w-full">
                                <h3 className="text-lg font-semibold mb-4">Request Quotes</h3>
                                <div className="space-y-2 text-sm mb-4">
                                    <p><strong>Collection:</strong> {collection.location}, {collection.country}</p>
                                    <p><strong>Delivery:</strong> {delivery.location}, {delivery.country}</p>
                                    <p><strong>Type:</strong> {isFullTruck ? 'Full Truck Load' : `${pallets} Pallets`}</p>
                                </div>
                                <div className="flex gap-2">
                                    <button 
                                        onClick={handleSendQuote}
                                        disabled={sending}
                                        className="flex-1 azelis-blue text-white p-2 rounded hover:opacity-90 disabled:opacity-50"
                                    >
                                        {sending ? "Sending..." : "Send Request"}
                                    </button>
                                    <button 
                                        onClick={() => setShowQuoteForm(false)}
                                        disabled={sending}
                                        className="flex-1 bg-gray-200 p-2 rounded hover:bg-gray-300"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>

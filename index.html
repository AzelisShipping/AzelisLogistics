<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azelis Shipping Calculator</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>
        (function() {
            emailjs.init('ZU_ZvcimnTfLR22wF');
        })();
    </script>
    <script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        .azelis-blue { background-color: #003087; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const App = () => {
            const [collection, setCollection] = React.useState({ country: '', location: '', postcode: '' });
            const [delivery, setDelivery] = React.useState({ country: '', location: '', postcode: '' });
            const [pallets, setPallets] = React.useState(1);
            const [deliveryType, setDeliveryType] = React.useState('STD');
            const [price, setPrice] = React.useState(null);
            const [sending, setSending] = React.useState(false);
            const [showModal, setShowModal] = React.useState(false);
            const [isFullTruck, setIsFullTruck] = React.useState(false);

            const countries = ["UK", "BEL", "FRA", "GER", "NLD", "ESP", "ITA"];

            const sendQuoteRequests = async () => {
                setSending(true);
                try {
                    const hauliers = JSON.parse(localStorage.getItem('hauliers') || '[]');
                    const relevantHauliers = hauliers.filter(h => 
                        h.active && 
                        (h.countries.includes(collection.country) || h.countries.includes(delivery.country))
                    );

                    if (relevantHauliers.length === 0) {
                        alert('No active hauliers found for these countries');
                        return;
                    }

                    const emailBody = `
Collection:
Country: ${collection.country}
Location: ${collection.location}
Postcode: ${collection.postcode}

Delivery:
Country: ${delivery.country}
Location: ${delivery.location}
Postcode: ${delivery.postcode}

Shipment Details:
Type: ${isFullTruck ? 'Full Truck Load' : `${pallets} Pallets`}
Delivery Type: ${deliveryType}`;

                    await Promise.all(relevantHauliers.map(haulier => 
                        emailjs.send(
                            'Azelis_Logistics',
                            'template_hho0c06',
                            {
                                to_email: haulier.email,
                                reply_to: 'greg.michell@azelis.com',
                                subject: `Quote Request: ${collection.country} to ${delivery.country}`,
                                message: emailBody
                            }
                        )
                    ));

                    alert('Quote requests sent successfully!');
                    setShowModal(false);
                } catch (error) {
                    console.error('Failed to send emails:', error);
                    alert('Failed to send quote requests. Please try again.');
                } finally {
                    setSending(false);
                }
            };

            const calculatePrice = () => {
                if (!collection.country || !delivery.country) {
                    alert('Please fill in both collection and delivery details');
                    return;
                }
                
                const hasRate = Math.random() > 0.5;
                if (hasRate) {
                    const basePrice = 350 + (Math.random() * 200);
                    setPrice(basePrice * (isFullTruck ? 24 : pallets));
                } else {
                    setPrice(null);
                    if (confirm('No existing rate found. Request quotes?')) {
                        setShowModal(true);
                    }
                }
            };

            return (
                <div className="max-w-4xl mx-auto p-4">
                    <div className="bg-white rounded-lg shadow p-6">
                        <h1 className="text-2xl font-bold mb-6">Shipping Calculator</h1>
                        
                        {/* Form Content */}
                        <div className="space-y-6">
                            {/* Addresses */}
                            <div className="grid grid-cols-1 gap-6">
                                <div>
                                    <h2 className="text-lg font-medium mb-2">Collection Details</h2>
                                    <div className="grid grid-cols-3 gap-4">
                                        <div>
                                            <select 
                                                className="w-full p-2 border rounded"
                                                value={collection.country}
                                                onChange={e => setCollection({...collection, country: e.target.value})}
                                            >
                                                <option value="">Select Country</option>
                                                {countries.map(c => (
                                                    <option key={c} value={c}>{c}</option>
                                                ))}
                                            </select>
                                        </div>
                                        <div>
                                            <input 
                                                placeholder="Location"
                                                className="w-full p-2 border rounded"
                                                value={collection.location}
                                                onChange={e => setCollection({...collection, location: e.target.value})}
                                            />
                                        </div>
                                        <div>
                                            <input 
                                                placeholder="Postcode"
                                                className="w-full p-2 border rounded"
                                                value={collection.postcode}
                                                onChange={e => setCollection({...collection, postcode: e.target.value})}
                                            />
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <h2 className="text-lg font-medium mb-2">Delivery Details</h2>
                                    <div className="grid grid-cols-3 gap-4">
                                        <div>
                                            <select 
                                                className="w-full p-2 border rounded"
                                                value={delivery.country}
                                                onChange={e => setDelivery({...delivery, country: e.target.value})}
                                            >
                                                <option value="">Select Country</option>
                                                {countries.map(c => (
                                                    <option key={c} value={c}>{c}</option>
                                                ))}
                                            </select>
                                        </div>
                                        <div>
                                            <input 
                                                placeholder="Location"
                                                className="w-full p-2 border rounded"
                                                value={delivery.location}
                                                onChange={e => setDelivery({...delivery, location: e.target.value})}
                                            />
                                        </div>
                                        <div>
                                            <input 
                                                placeholder="Postcode"
                                                className="w-full p-2 border rounded"
                                                value={delivery.postcode}
                                                onChange={e => setDelivery({...delivery, postcode: e.target.value})}
                                            />
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Shipping Options */}
                            <div>
                                <h2 className="text-lg font-medium mb-2">Shipping Options</h2>
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <select 
                                            className="w-full p-2 border rounded"
                                            value={isFullTruck ? 'full' : 'partial'}
                                            onChange={e => setIsFullTruck(e.target.value === 'full')}
                                        >
                                            <option value="partial">Partial Load</option>
                                            <option value="full">Full Truck</option>
                                        </select>
                                    </div>
                                    {!isFullTruck && (
                                        <div>
                                            <input 
                                                type="number"
                                                min="1"
                                                max="24"
                                                placeholder="Number of Pallets"
                                                className="w-full p-2 border rounded"
                                                value={pallets}
                                                onChange={e => setPallets(parseInt(e.target.value) || 1)}
                                            />
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* Calculate Button */}
                            <button
                                onClick={calculatePrice}
                                className="w-full bg-blue-600 text-white p-3 rounded font-medium hover:bg-blue-700"
                            >
                                Calculate Price
                            </button>

                            {/* Price Display */}
                            {price && (
                                <div className="p-4 bg-green-50 border border-green-200 rounded">
                                    <p className="text-xl font-bold text-green-700">
                                        Price: £{price.toFixed(2)}
                                    </p>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Quote Request Modal */}
                    {showModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-lg p-6 max-w-md w-full">
                                <h3 className="text-lg font-semibold mb-4">Request Quotes</h3>
                                <div className="space-y-2 mb-4">
                                    <p><strong>Collection:</strong> {collection.location}, {collection.country}</p>
                                    <p><strong>Delivery:</strong> {delivery.location}, {delivery.country}</p>
                                    <p><strong>Type:</strong> {isFullTruck ? 'Full Truck Load' : `${pallets} Pallets`}</p>
                                </div>
                                <div className="flex gap-2">
                                    <button 
                                        onClick={sendQuoteRequests}
                                        disabled={sending}
                                        className="flex-1 bg-blue-600 text-white p-2 rounded hover:bg-blue-700 disabled:opacity-50"
                                    >
                                        {sending ? "Sending..." : "Send Requests"}
                                    </button>
                                    <button 
                                        onClick={() => setShowModal(false)}
                                        disabled={sending}
                                        className="flex-1 bg-gray-200 p-2 rounded hover:bg-gray-300"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>

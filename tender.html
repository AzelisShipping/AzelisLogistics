<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tender Details - Azelis Shipping</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <!-- EmailJS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
    <script>
        (function(){
            emailjs.init("ZU_ZvcimnTfLR22wF"); // Initialize EmailJS with your public key
        })();
    </script>
    <style>
        /* Custom Styles for better readability */
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .header {
            background-color: #003087;
            color: #ffffff;
            padding: 15px;
            text-align: center;
            border-radius: 8px 8px 0 0;
        }
        .details-section {
            margin-top: 20px;
        }
        .details-section h3 {
            margin-bottom: 10px;
            color: #003087;
        }
        .details-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .details-table td, .details-table th {
            padding: 10px;
            border-bottom: 1px solid #dddddd;
        }
        .details-table th {
            background-color: #f9f9f9;
            text-align: left;
            width: 30%;
        }
        .pallet-rates table th, .pallet-rates table td {
            padding: 8px;
            border: 1px solid #dddddd;
            text-align: center;
        }
        .footer {
            font-size: 0.8em;
            color: #666666;
            text-align: center;
            padding: 10px;
            border-top: 1px solid #eeeeee;
            margin-top: 20px;
            border-radius: 0 0 8px 8px;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container">
        <!-- Header Section -->
        <div class="header">
            <h2>Tender Details</h2>
        </div>

        <!-- Content Section -->
        <div class="p-4">
            <p class="mb-4">Dear {{haulierName}},</p>
            <p>Azelis has received your quote submission for the following tender. Please review the details below:</p>

            <!-- Quote Submission Details -->
            <div class="details-section">
                <h3>Quote Submission Details:</h3>
                <table class="details-table">
                    <tr>
                        <th>Tender ID</th>
                        <td>{{tenderId}}</td>
                    </tr>
                    <tr>
                        <th>Haulier Name</th>
                        <td>{{haulierName}}</td>
                    </tr>
                    <tr>
                        <th>Haulier Email</th>
                        <td>{{haulierEmail}}</td>
                    </tr>
                    <tr>
                        <th>Price</th>
                        <td>{{price}} {{currency}}</td>
                    </tr>
                    <tr>
                        <th>Valid Until</th>
                        <td>{{validUntil}}</td>
                    </tr>
                    <tr>
                        <th>Estimated Transit Time</th>
                        <td>{{transitTime}} days</td>
                    </tr>
                    <tr>
                        <th>Fixed Rate Surcharges</th>
                        <td>{{fixedRateSurcharges}} {{currency}}</td>
                    </tr>
                    <tr>
                        <th>% Surcharge</th>
                        <td>{{percentSurcharge}}%</td>
                    </tr>
                    <tr>
                        <th>Total</th>
                        <td>{{total}} {{currency}}</td>
                    </tr>
                    <tr>
                        <th>Acknowledge Hide Commercial Documents</th>
                        <td>{{hideDocuments}}</td>
                    </tr>
                </table>
            </div>

            <!-- Transport and Route Details -->
            <div class="details-section">
                <h3>Transport and Route Details:</h3>
                <table class="details-table">
                    <tr>
                        <th>Transport Mode</th>
                        <td>{{transportMode}}</td>
                    </tr>
                    <tr>
                        <th>Weight Bucket</th>
                        <td>{{weightBucket}}</td>
                    </tr>
                    <tr>
                        <th>Incoterms</th>
                        <td>{{incoterms}}</td>
                    </tr>
                    <tr>
                        <th>Delivery Type</th>
                        <td>{{deliveryType}}</td>
                    </tr>
                    <tr>
                        <th>Load Type</th>
                        <td>{{loadType}}</td>
                    </tr>
                    <tr>
                        <th>Pallets</th>
                        <td>{{pallets}}</td>
                    </tr>
                    <tr>
                        <th>Pallet Type</th>
                        <td>{{palletType}}</td>
                    </tr>
                    <tr>
                        <th>Container Type</th>
                        <td>{{containerType}}</td>
                    </tr>
                    <tr>
                        <th>Air Weight (KG)</th>
                        <td>{{airWeight}}</td>
                    </tr>
                    <tr>
                        <th>Volume (CBM)</th>
                        <td>{{volume}}</td>
                    </tr>
                    <tr>
                        <th>Is Peak Season</th>
                        <td>{{isPeakSeason}}</td>
                    </tr>
                    <tr>
                        <th>Peak Season Details</th>
                        <td>{{peakSeasonDetails}}</td>
                    </tr>
                    <tr>
                        <th>Urgency</th>
                        <td>{{urgency}}</td>
                    </tr>
                    <tr>
                        <th>Preferred Delivery Date</th>
                        <td>{{preferredDeliveryDate}}</td>
                    </tr>
                    <!-- Collection Details -->
                    <tr>
                        <th>Collection Country</th>
                        <td>{{collectionCountry}}</td>
                    </tr>
                    <tr>
                        <th>Collection Postcode</th>
                        <td>{{collectionPostcode}}</td>
                    </tr>
                    <tr>
                        <th>Collection Location</th>
                        <td>{{collectionLocation}}</td>
                    </tr>
                    <!-- Delivery Details -->
                    <tr>
                        <th>Delivery Country</th>
                        <td>{{deliveryCountry}}</td>
                    </tr>
                    <tr>
                        <th>Delivery Postcode</th>
                        <td>{{deliveryPostcode}}</td>
                    </tr>
                    <tr>
                        <th>Delivery Location</th>
                        <td>{{deliveryLocation}}</td>
                    </tr>
                    <!-- Route Details -->
                    <tr>
                        <th>Waypoint 1</th>
                        <td>{{waypoint1}}</td>
                    </tr>
                    <tr>
                        <th>Waypoint 2</th>
                        <td>{{waypoint2}}</td>
                    </tr>
                    <tr>
                        <th>Waypoint 3</th>
                        <td>{{waypoint3}}</td>
                    </tr>
                    <tr>
                        <th>Waypoint 4</th>
                        <td>{{waypoint4}}</td>
                    </tr>
                    <tr>
                        <th>Waypoint 5</th>
                        <td>{{waypoint5}}</td>
                    </tr>
                </table>
            </div>

            <!-- Per-Pallet Rates -->
            <div class="details-section pallet-rates">
                <h3>Per-Pallet Rates:</h3>
                <table class="details-table">
                    <tr>
                        <th>Pallet Quantity</th>
                        <th>Rate ({{currency}})</th>
                    </tr>
                    {{palletRatesHTML}}
                </table>
            </div>

            <!-- Footer Section -->
            <div class="footer">
                <p>This is an automated message. Please do not reply directly to this email.</p>
                <p>Â© 2024 Azelis. All rights reserved.</p>
            </div>
        </div>

        <script>
            // Firebase configuration
            const firebaseConfig = {
                apiKey: "AIzaSyDiIRLwLeMAf1VZbZ7ygvGDu-gZH6sA424",
                authDomain: "azelislogistics.firebaseapp.com",
                projectId: "azelislogistics",
                storageBucket: "azelislogistics.appspot.com",
                messagingSenderId: "13102382958",
                appId: "1:13102382958:web:82a3324843432519cb8b7f",
                measurementId: "G-Q6JNN8DHJQ"
            };
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();

            // Retrieve URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const quoteId = urlParams.get('quoteId');
            const haulierId = urlParams.get('haulierId');

            // Function to display a message to the user
            function displayMessage(msg, isError = true) {
                const messageDiv = document.getElementById('message');
                if (messageDiv) {
                    messageDiv.textContent = msg;
                    messageDiv.className = isError ? 'mt-4 text-center text-red-500' : 'mt-4 text-center text-green-500';
                }
            }

            // Function to send internal notification email via EmailJS
            function sendInternalNotificationEmail(emailParams) {
                return emailjs.send('Azelis_Logistics', 'template_12utb0n', emailParams);
            }

            // Function to populate tender details in a condensed format
            async function populateTenderDetails() {
                if (!quoteId) {
                    displayMessage('Missing quoteId in URL parameters.');
                    return;
                }
                try {
                    const quoteDoc = await db.collection('quotes').doc(quoteId).get();
                    if (!quoteDoc.exists) {
                        displayMessage('Quote not found.');
                        return;
                    }
                    const quoteData = quoteDoc.data();
                    
                    // Use quoteId as tenderId since it's the document ID
                    const tenderId = quoteId;

                    // Prepare all necessary fields
                    const fields = {
                        tenderId: tenderId,
                        transportMode: quoteData.transportMode || 'N/A',
                        weightBucket: quoteData.weightBucket || 'N/A',
                        incoterms: quoteData.incoterms || 'N/A',
                        deliveryType: quoteData.deliveryType || 'N/A',
                        loadType: quoteData.loadType || 'N/A',
                        pallets: quoteData.pallets !== null ? quoteData.pallets : 'N/A',
                        palletType: quoteData.palletType || 'N/A',
                        containerType: quoteData.containerType || 'N/A',
                        airWeight: quoteData.airWeight !== null ? quoteData.airWeight : 'N/A',
                        volume: quoteData.volume !== null ? quoteData.volume : 'N/A',
                        isPeakSeason: quoteData.isPeakSeason ? 'Yes' : 'No',
                        peakSeasonDetails: quoteData.peakSeasonDetails || 'N/A',
                        urgency: quoteData.urgency || 'N/A',
                        preferredDeliveryDate: quoteData.preferredDeliveryDate || 'N/A',
                        collectionCountry: getCountryName(quoteData.collection.country) || 'N/A',
                        collectionPostcode: quoteData.collection.postcode || 'N/A',
                        collectionLocation: quoteData.collection.location || 'N/A',
                        deliveryCountry: getCountryName(quoteData.delivery.country) || 'N/A',
                        deliveryPostcode: quoteData.delivery.postcode || 'N/A',
                        deliveryLocation: quoteData.delivery.location || 'N/A',
                        waypoint1: formatWaypoint(quoteData.waypoints[0]),
                        waypoint2: formatWaypoint(quoteData.waypoints[1]),
                        waypoint3: formatWaypoint(quoteData.waypoints[2]),
                        waypoint4: formatWaypoint(quoteData.waypoints[3]),
                        waypoint5: formatWaypoint(quoteData.waypoints[4]),
                        price: quoteData.price !== null ? quoteData.price : 'N/A',
                        currency: quoteData.currency || 'N/A',
                        fixedRateSurcharges: quoteData.fixedRateSurcharges !== null ? quoteData.fixedRateSurcharges : 'N/A',
                        percentSurcharge: quoteData.percentSurcharge !== null ? quoteData.percentSurcharge : 'N/A',
                        total: quoteData.total !== null ? quoteData.total : 'N/A',
                        hideDocuments: quoteData.hideDocuments ? 'Yes' : 'No',
                        palletRates: quoteData.palletRates || {}
                    };

                    // Populate the tender overview table
                    for (const [key, value] of Object.entries(fields)) {
                        const element = document.getElementById(key);
                        if (element) {
                            element.textContent = value;
                        }
                    }

                    // Generate palletRatesHTML
                    let palletRatesHTML = '';
                    for (let i = 0; i <= 24; i++) {
                        const rate = fields.palletRates[i];
                        if (rate !== undefined) {
                            palletRatesHTML += `
                                <tr>
                                    <td class="px-4 py-2 border text-center">${i}</td>
                                    <td class="px-4 py-2 border text-center">${parseFloat(rate).toFixed(2)}</td>
                                </tr>
                            `;
                        }
                    }
                    // Insert palletRatesHTML into the table
                    const palletRatesContainer = document.querySelector('.pallet-rates table');
                    if (palletRatesContainer) {
                        palletRatesContainer.innerHTML += palletRatesHTML;
                    }

                    // Send internal notification email
                    const emailParams = {
                        to_email: "internaluser@azelis.com", // Replace with your internal user's email
                        subject: `New Quote Submission - Tender ID: ${tenderId}`,
                        tenderId: tenderId,
                        haulierName: haulierId || 'N/A', // If haulierId represents the haulier's name; adjust as needed
                        haulierEmail: quoteData.userEmail || 'N/A',
                        price: fields.price,
                        currency: fields.currency,
                        validUntil: quoteData.validUntil || 'N/A',
                        transitTime: quoteData.transitTime || 'N/A',
                        fixedRateSurcharges: fields.fixedRateSurcharges,
                        percentSurcharge: fields.percentSurcharge,
                        total: fields.total,
                        hideDocuments: fields.hideDocuments,
                        transportMode: fields.transportMode,
                        weightBucket: fields.weightBucket,
                        incoterms: fields.incoterms,
                        deliveryType: fields.deliveryType,
                        loadType: fields.loadType,
                        pallets: fields.pallets,
                        palletType: fields.palletType,
                        containerType: fields.containerType,
                        airWeight: fields.airWeight,
                        volume: fields.volume,
                        isPeakSeason: fields.isPeakSeason,
                        peakSeasonDetails: fields.peakSeasonDetails,
                        urgency: fields.urgency,
                        preferredDeliveryDate: fields.preferredDeliveryDate,
                        collectionCountry: fields.collectionCountry,
                        collectionPostcode: fields.collectionPostcode,
                        collectionLocation: fields.collectionLocation,
                        deliveryCountry: fields.deliveryCountry,
                        deliveryPostcode: fields.deliveryPostcode,
                        deliveryLocation: fields.deliveryLocation,
                        waypoint1: fields.waypoint1,
                        waypoint2: fields.waypoint2,
                        waypoint3: fields.waypoint3,
                        waypoint4: fields.waypoint4,
                        waypoint5: fields.waypoint5,
                        palletRatesHTML: palletRatesHTML // Pre-rendered HTML table
                    };

                    // Send the email
                    await sendInternalNotificationEmail(emailParams);
                    console.log('Internal notification email sent successfully!');
                    
                } catch (error) {
                    console.error('Error fetching quote details:', error);
                    displayMessage('Error fetching quote details. Please try again.');
                }
            }

            // Helper function to get country name from code
            function getCountryName(code) {
                // Replace with your actual country mapping logic
                // For example, if you have a COUNTRY_MAPPING object
                const COUNTRY_MAPPING = {
                    "AFG": "Afghanistan",
                    "ALB": "Albania",
                    "DZA": "Algeria",
                    "AND": "Andorra",
                    "AGO": "Angola",
                    // ... (include all country codes and names)
                    "GBR": "United Kingdom",
                    "USA": "United States",
                    // Add all other necessary country codes
                };
                return COUNTRY_MAPPING[code] || code;
            }

            // Helper function to format waypoint
            function formatWaypoint(wp) {
                if (!wp) return 'N/A';
                const countryName = getCountryName(wp.country) || wp.country;
                return `Country: ${countryName}, Postcode: ${wp.postcode}`;
            }

            // Call the function to populate tender details on page load
            window.onload = populateTenderDetails;
        </script>
</body>
</html>

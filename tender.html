<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Submit Your Quote - Azelis Logistics</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        .azelis-blue { background-color: #003087; }
        .azelis-blue-hover:hover { background-color: #002670; }
        .pallet-rates-table { max-height: 500px; overflow-y: auto; }
        .table-header { position: sticky; top: 0; background: white; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <!-- Dependencies -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDiIRLwLeMAf1VZbZ7ygvGDu-gZH6sA424",
            authDomain: "azelislogistics.firebaseapp.com",
            projectId: "azelislogistics",
            storageBucket: "azelislogistics.appspot.com",
            messagingSenderId: "13102382958",
            appId: "1:13102382958:web:82a3324843432519cb8b7f"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Initialize EmailJS
        emailjs.init("ZU_ZvcimnTfLR22wF");
    </script>

    <script type="text/babel">
        const TenderForm = () => {
            const [quoteData, setQuoteData] = React.useState(null);
            const [loading, setLoading] = React.useState(true);
            const [error, setError] = React.useState(null);
            const [sending, setSending] = React.useState(false);
            const [palletRates, setPalletRates] = React.useState({});
            const [surcharges, setSurcharges] = React.useState({
                fixed: 0,
                percent: 0
            });

            const params = new URLSearchParams(window.location.search);
            const quoteId = params.get('quoteId');
            const haulierId = params.get('haulierId');

            React.useEffect(() => {
                const fetchQuoteData = async () => {
                    try {
                        const doc = await db.collection('quotes').doc(quoteId).get();
                        if (!doc.exists) throw new Error('Quote not found');
                        setQuoteData({ id: doc.id, ...doc.data() });
                    } catch (err) {
                        setError(err.message);
                    } finally {
                        setLoading(false);
                    }
                };

                if (quoteId) fetchQuoteData();
            }, [quoteId]);

            const handlePalletRateChange = (pallets, rate) => {
                setPalletRates(prev => ({
                    ...prev,
                    [pallets]: parseFloat(rate) || 0
                }));
            };

            const calculateTotal = (baseRate) => {
                const base = parseFloat(baseRate) || 0;
                const fixedSurcharge = parseFloat(surcharges.fixed) || 0;
                const percentAmount = base * (parseFloat(surcharges.percent) || 0) / 100;
                return base + fixedSurcharge + percentAmount;
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setSending(true);
                try {
                    const formData = new FormData(e.target);
                    const response = {
                        haulierId,
                        submittedAt: new Date(),
                        currency: formData.get('currency'),
                        validUntil: formData.get('validUntil'),
                        transitTime: parseInt(formData.get('transitTime')),
                        surcharges: {
                            fixed: parseFloat(formData.get('fixedSurcharge')) || 0,
                            percent: parseFloat(formData.get('percentSurcharge')) || 0
                        }
                    };

                    if (quoteData?.loadType === 'Full Truck Load') {
                        response.basePrice = parseFloat(formData.get('basePrice')) || 0;
                        response.totalPrice = calculateTotal(response.basePrice);
                    } else {
                        response.palletRates = palletRates;
                    }

                    // Update quote in Firestore
                    await db.collection('quotes').doc(quoteId).update({
                        responses: firebase.firestore.FieldValue.arrayUnion(response)
                    });

                    // Send email notification
                    await emailjs.send(
                        'Azelis_Logistics',
                        'template_12utb0n',
                        {
                            to_email: quoteData.userEmail,
                            subject: `Quote Response - ${quoteId}`,
                            quoteId,
                            ...response
                        }
                    );

                    alert('Quote submitted successfully!');
                    e.target.style.opacity = '0.5';
                    e.target.style.pointerEvents = 'none';
                } catch (err) {
                    setError(err.message);
                } finally {
                    setSending(false);
                }
            };

            if (loading) return <div className="text-center p-8">Loading...</div>;
            if (error) return <div className="text-red-600 p-8">{error}</div>;
            if (!quoteData) return null;

            const maxPallets = quoteData.getAllPalletRates ? 24 : (quoteData.pallets || 24);

            return (
                <div className="max-w-7xl mx-auto p-4">
                    <div className="bg-white rounded-lg shadow-lg p-6">
                        <div className="flex justify-center mb-6">
                            <img src="https://www.azelis.com/themes/custom/azelis_theme/logo.svg" alt="Azelis Logo" className="h-12" />
                        </div>

                        {/* Quote Details */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                            <div className="border rounded p-4">
                                <h3 className="font-semibold mb-2">Route Details</h3>
                                <p>From: {quoteData.collection?.country} - {quoteData.collection?.postcode}</p>
                                <p>To: {quoteData.delivery?.country} - {quoteData.delivery?.postcode}</p>
                            </div>
                            
                            <div className="border rounded p-4">
                                <h3 className="font-semibold mb-2">Transport Details</h3>
                                <p>Mode: {quoteData.transportMode}</p>
                                <p>Weight: {quoteData.weightBucket}</p>
                                <p>Load Type: {quoteData.loadType}</p>
                            </div>
                            
                            <div className="border rounded p-4">
                                <h3 className="font-semibold mb-2">Additional Info</h3>
                                <p>Delivery Type: {quoteData.deliveryType}</p>
                                <p>Incoterms: {quoteData.incoterms}</p>
                                {quoteData.volume && <p>Volume: {quoteData.volume} CBM</p>}
                            </div>
                        </div>

                        {/* Quote Form */}
                        <form onSubmit={handleSubmit} className="space-y-6">
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label className="block text-sm font-medium mb-1">Currency *</label>
                                    <select name="currency" required className="w-full p-2 border rounded">
                                        <option value="GBP">GBP (£)</option>
                                        <option value="EUR">EUR (€)</option>
                                        <option value="USD">USD ($)</option>
                                    </select>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium mb-1">Valid Until *</label>
                                    <input
                                        type="date"
                                        name="validUntil"
                                        required
                                        className="w-full p-2 border rounded"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium mb-1">Transit Time (Days) *</label>
                                    <input
                                        type="number"
                                        name="transitTime"
                                        required
                                        min="1"
                                        className="w-full p-2 border rounded"
                                    />
                                </div>
                            </div>

                            {/* Pricing Section */}
                            {quoteData.loadType === 'Full Truck Load' ? (
                                <div>
                                    <h3 className="text-lg font-medium mb-4">Full Truck Load Pricing</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Base Price *</label>
                                            <input
                                                type="number"
                                                name="basePrice"
                                                required
                                                step="0.01"
                                                className="w-full p-2 border rounded"
                                            />
                                        </div>
                                    </div>
                                </div>
                            ) : (
                                <div>
                                    <h3 className="text-lg font-medium mb-4">Pallet Rates</h3>
                                    <div className="pallet-rates-table">
                                        <table className="w-full">
                                            <thead className="table-header">
                                                <tr>
                                                    <th className="px-4 py-2 text-left">Pallets</th>
                                                    <th className="px-4 py-2 text-left">Rate</th>
                                                    <th className="px-4 py-2 text-left">Total (inc. Surcharges)</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {[...Array(maxPallets)].map((_, i) => (
                                                    <tr key={i}>
                                                        <td className="px-4 py-2">{i + 1}</td>
                                                        <td className="px-4 py-2">
                                                            <input
                                                                type="number"
                                                                step="0.01"
                                                                className="w-full p-2 border rounded"
                                                                value={palletRates[i + 1] || ''}
                                                                onChange={(e) => handlePalletRateChange(i + 1, e.target.value)}
                                                                required
                                                            />
                                                        </td>
                                                        <td className="px-4 py-2">
                                                            {calculateTotal(palletRates[i + 1]).toFixed(2)}
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            )}

                            {/* Surcharges */}
                            <div>
                                <h3 className="text-lg font-medium mb-4">Surcharges</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Fixed Surcharge</label>
                                        <input
                                            type="number"
                                            name="fixedSurcharge"
                                            step="0.01"
                                            className="w-full p-2 border rounded"
                                            value={surcharges.fixed}
                                            onChange={(e) => setSurcharges(prev => ({
                                                ...prev,
                                                fixed: e.target.value
                                            }))}
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Percentage Surcharge (%)</label>
                                        <input
                                            type="number"
                                            name="percentSurcharge"
                                            step="0.01"
                                            className="w-full p-2 border rounded"
                                            value={surcharges.percent}
                                            onChange={(e) => setSurcharges(prev => ({
                                                ...prev,
                                                percent: e.target.value
                                            }))}
                                        />
                                    </div>
                                </div>
                            </div>

                            <button
                                type="submit"
                                disabled={sending}
                                className="w-full azelis-blue text-white p-3 rounded-lg hover:bg-blue-700 disabled:opacity-50"
                            >
                                {sending ? 'Submitting...' : 'Submit Quote'}
                            </button>
                        </form>

                        {error && (
                            <div className="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700">
                                {error}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        ReactDOM.render(<TenderForm />, document.getElementById('root'));
    </script>
</body>
</html>

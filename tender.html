<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Submit Your Quote - Azelis Shipping</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <!-- EmailJS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
    <script>
        (function(){
            emailjs.init("ZU_ZvcimnTfLR22wF"); // Initialize EmailJS with your public key
        })();
    </script>
</head>
<body class="bg-gray-50">
    <div class="max-w-4xl mx-auto p-6 mt-10 bg-white rounded shadow">
        <h2 class="text-3xl font-bold mb-6 text-center">Submit Your Quote</h2>
        <form id="submitQuoteForm" class="space-y-6">
            <!-- Basic Details -->
            <div>
                <label class="block text-sm font-medium">Price *</label>
                <input type="number" name="price" required class="w-full p-2 border rounded" step="0.01" placeholder="Enter your price">
            </div>
            <div>
                <label class="block text-sm font-medium">Currency *</label>
                <select name="currency" required class="w-full p-2 border rounded">
                    <option value="">Select Currency</option>
                    <option value="GBP">GBP (£)</option>
                    <option value="EUR">EUR (€)</option>
                    <option value="USD">USD ($)</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium">Valid Until *</label>
                <input type="date" name="validUntil" required class="w-full p-2 border rounded">
            </div>
            <div>
                <label class="block text-sm font-medium">Estimated Transit Time (Days)</label>
                <input type="number" name="transitTime" class="w-full p-2 border rounded" min="1" placeholder="e.g., 5">
            </div>

            <!-- Additional Services -->
            <div>
                <label class="block text-sm font-medium">Additional Services</label>
                <div class="flex items-center mt-2">
                    <input type="checkbox" name="isPeakSeason" value="Yes" class="mr-2">
                    <span>Is Peak Season?</span>
                </div>
                <div class="mt-2">
                    <label class="block text-sm font-medium">Peak Season Details</label>
                    <input type="text" name="peakSeasonDetails" class="w-full p-2 border rounded" placeholder="Provide details if applicable">
                </div>
                <div class="mt-2">
                    <label class="block text-sm font-medium">Urgency</label>
                    <input type="text" name="urgency" class="w-full p-2 border rounded" placeholder="e.g., High, Medium, Low">
                </div>
                <div class="mt-2">
                    <label class="block text-sm font-medium">Preferred Delivery Date</label>
                    <input type="date" name="preferredDeliveryDate" class="w-full p-2 border rounded">
                </div>
                <div class="mt-2">
                    <label class="flex items-center">
                        <input type="checkbox" name="hideDocuments" value="Yes" class="mr-2">
                        Hide Documents
                    </label>
                </div>
            </div>

            <!-- Transport Details -->
            <div>
                <h3 class="text-xl font-semibold mb-2">Transport Details</h3>
                <div>
                    <label class="block text-sm font-medium">Transport Mode</label>
                    <input type="text" name="transportMode" class="w-full p-2 border rounded" placeholder="e.g., Road, Air, Sea">
                </div>
                <div class="mt-2">
                    <label class="block text-sm font-medium">Weight Bucket</label>
                    <input type="text" name="weightBucket" class="w-full p-2 border rounded" placeholder="e.g., 1ton-5tons">
                </div>
                <div class="mt-2">
                    <label class="block text-sm font-medium">Incoterms</label>
                    <input type="text" name="incoterms" class="w-full p-2 border rounded" placeholder="e.g., FOB, CIF">
                </div>
                <div class="mt-2">
                    <label class="block text-sm font-medium">Delivery Type</label>
                    <input type="text" name="deliveryType" class="w-full p-2 border rounded" placeholder="e.g., Express, Standard">
                </div>
            </div>

            <!-- Load Details -->
            <div>
                <h3 class="text-xl font-semibold mb-2">Load Details</h3>
                <div>
                    <label class="block text-sm font-medium">Load Type</label>
                    <input type="text" name="loadType" class="w-full p-2 border rounded" placeholder="e.g., Full Truck Load, Partial Load">
                </div>
                <div class="mt-2">
                    <label class="block text-sm font-medium">Pallets</label>
                    <input type="number" name="pallets" class="w-full p-2 border rounded" min="0" placeholder="Number of pallets">
                </div>
                <div class="mt-2">
                    <label class="block text-sm font-medium">Pallet Type</label>
                    <input type="text" name="palletType" class="w-full p-2 border rounded" placeholder="e.g., Standard, Euro">
                </div>
                <div class="mt-2">
                    <label class="block text-sm font-medium">Container Type</label>
                    <input type="text" name="containerType" class="w-full p-2 border rounded" placeholder="e.g., 20ft, 40ft">
                </div>
                <div class="mt-2">
                    <label class="block text-sm font-medium">Air Weight (KG)</label>
                    <input type="number" name="airWeight" class="w-full p-2 border rounded" min="0" step="0.01" placeholder="Enter air weight">
                </div>
                <div class="mt-2">
                    <label class="block text-sm font-medium">Volume (CBM)</label>
                    <input type="number" name="volume" class="w-full p-2 border rounded" min="0" step="0.01" placeholder="Enter volume">
                </div>
            </div>

            <!-- Route Details -->
            <div>
                <h3 class="text-xl font-semibold mb-2">Route Details</h3>
                <div>
                    <label class="block text-sm font-medium">Collection Country</label>
                    <input type="text" name="collectionCountry" class="w-full p-2 border rounded" placeholder="e.g., GBR">
                </div>
                <div class="mt-2">
                    <label class="block text-sm font-medium">Collection Postcode</label>
                    <input type="text" name="collectionPostcode" class="w-full p-2 border rounded" placeholder="e.g., 22222">
                </div>
                <div class="mt-2">
                    <label class="block text-sm font-medium">Collection Location</label>
                    <input type="text" name="collectionLocation" class="w-full p-2 border rounded" placeholder="e.g., N/A">
                </div>
                <div class="mt-2">
                    <label class="block text-sm font-medium">Delivery Country</label>
                    <input type="text" name="deliveryCountry" class="w-full p-2 border rounded" placeholder="e.g., GBR">
                </div>
                <div class="mt-2">
                    <label class="block text-sm font-medium">Delivery Postcode</label>
                    <input type="text" name="deliveryPostcode" class="w-full p-2 border rounded" placeholder="e.g., CH66 1PF">
                </div>
                <div class="mt-2">
                    <label class="block text-sm font-medium">Delivery Location</label>
                    <input type="text" name="deliveryLocation" class="w-full p-2 border rounded" placeholder="e.g., N/A">
                </div>
            </div>

            <!-- Waypoints -->
            <div>
                <h3 class="text-xl font-semibold mb-2">Waypoints</h3>
                <div>
                    <label class="block text-sm font-medium">Waypoint 1</label>
                    <input type="text" name="waypoint1" class="w-full p-2 border rounded" placeholder="e.g., Location 1">
                </div>
                <div class="mt-2">
                    <label class="block text-sm font-medium">Waypoint 2</label>
                    <input type="text" name="waypoint2" class="w-full p-2 border rounded" placeholder="e.g., Location 2">
                </div>
                <div class="mt-2">
                    <label class="block text-sm font-medium">Waypoint 3</label>
                    <input type="text" name="waypoint3" class="w-full p-2 border rounded" placeholder="e.g., Location 3">
                </div>
                <div class="mt-2">
                    <label class="block text-sm font-medium">Waypoint 4</label>
                    <input type="text" name="waypoint4" class="w-full p-2 border rounded" placeholder="e.g., Location 4">
                </div>
                <div class="mt-2">
                    <label class="block text-sm font-medium">Waypoint 5</label>
                    <input type="text" name="waypoint5" class="w-full p-2 border rounded" placeholder="e.g., Location 5">
                </div>
            </div>

            <!-- Submit Button -->
            <div>
                <button type="submit" class="w-full bg-blue-600 text-white p-3 rounded hover:bg-blue-700">Submit Quote</button>
            </div>
        </form>
        <div id="message" class="mt-4 text-center"></div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDiIRLwLeMAf1VZbZ7ygvGDu-gZH6sA424",
            authDomain: "azelislogistics.firebaseapp.com",
            projectId: "azelislogistics",
            storageBucket: "azelislogistics.appspot.com",
            messagingSenderId: "13102382958",
            appId: "1:13102382958:web:82a3324843432519cb8b7f",
            measurementId: "G-Q6JNN8DHJQ"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Retrieve URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const quoteId = urlParams.get('quoteId');
        const haulierId = urlParams.get('haulierId');

        // Function to display a message to the user
        function displayMessage(msg, isError = true) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = msg;
            messageDiv.className = isError ? 'mt-4 text-center text-red-500' : 'mt-4 text-center text-green-500';
        }

        // Function to send email via EmailJS
        function sendNotificationEmail(emailParams) {
            return emailjs.send('Azelis_Logistics', 'template_12utb0n', emailParams);
        }

        document.getElementById('submitQuoteForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            displayMessage(''); // Clear any previous messages

            // Basic validation for URL parameters
            if (!quoteId || !haulierId) {
                displayMessage('Missing quoteId or haulierId in URL parameters.');
                return;
            }

            // Gather form data
            const formData = new FormData(e.target);
            const price = parseFloat(formData.get('price'));
            const currency = formData.get('currency');
            const validUntil = formData.get('validUntil');
            const transitTime = formData.get('transitTime') ? parseInt(formData.get('transitTime')) : null;
            const isPeakSeason = formData.get('isPeakSeason') === 'Yes' ? 'Yes' : 'No';
            const peakSeasonDetails = formData.get('peakSeasonDetails') || 'N/A';
            const urgency = formData.get('urgency') || 'N/A';
            const preferredDeliveryDate = formData.get('preferredDeliveryDate') || 'N/A';
            const hideDocuments = formData.get('hideDocuments') === 'Yes' ? 'Yes' : 'No';
            const transportMode = formData.get('transportMode') || 'N/A';
            const weightBucket = formData.get('weightBucket') || 'N/A';
            const incoterms = formData.get('incoterms') || 'N/A';
            const deliveryType = formData.get('deliveryType') || 'N/A';
            const loadType = formData.get('loadType') || 'N/A';
            const pallets = formData.get('pallets') || 'N/A';
            const palletType = formData.get('palletType') || 'N/A';
            const containerType = formData.get('containerType') || 'N/A';
            const airWeight = formData.get('airWeight') || 'N/A';
            const volume = formData.get('volume') || 'N/A';
            const collectionCountry = formData.get('collectionCountry') || 'N/A';
            const collectionPostcode = formData.get('collectionPostcode') || 'N/A';
            const collectionLocation = formData.get('collectionLocation') || 'N/A';
            const deliveryCountry = formData.get('deliveryCountry') || 'N/A';
            const deliveryPostcode = formData.get('deliveryPostcode') || 'N/A';
            const deliveryLocation = formData.get('deliveryLocation') || 'N/A';
            const waypoint1 = formData.get('waypoint1') || 'N/A';
            const waypoint2 = formData.get('waypoint2') || 'N/A';
            const waypoint3 = formData.get('waypoint3') || 'N/A';
            const waypoint4 = formData.get('waypoint4') || 'N/A';
            const waypoint5 = formData.get('waypoint5') || 'N/A';

            // Prepare rate data
            const rateData = {
                price: price,
                currency: currency,
                validUntil: validUntil,
                transitTime: transitTime,
                isPeakSeason: isPeakSeason,
                peakSeasonDetails: peakSeasonDetails,
                urgency: urgency,
                preferredDeliveryDate: preferredDeliveryDate,
                hideDocuments: hideDocuments,
                transportMode: transportMode,
                weightBucket: weightBucket,
                incoterms: incoterms,
                deliveryType: deliveryType,
                loadType: loadType,
                pallets: pallets,
                palletType: palletType,
                containerType: containerType,
                airWeight: airWeight,
                volume: volume,
                collectionCountry: collectionCountry,
                collectionPostcode: collectionPostcode,
                collectionLocation: collectionLocation,
                deliveryCountry: deliveryCountry,
                deliveryPostcode: deliveryPostcode,
                deliveryLocation: deliveryLocation,
                waypoint1: waypoint1,
                waypoint2: waypoint2,
                waypoint3: waypoint3,
                waypoint4: waypoint4,
                waypoint5: waypoint5,
                haulierId: haulierId,
                quoteId: quoteId,
                submittedAt: new Date()
            };

            console.log('Submitting rate:', rateData); // Debugging

            try {
                // Add rate to 'rates' collection
                const rateRef = await db.collection('rates').add(rateData);
                console.log('Rate added with ID:', rateRef.id); // Debugging

                // Update quote status
                await db.collection('quotes').doc(quoteId).update({
                    status: 'responded',
                    respondedAt: new Date(),
                    responseBy: haulierId
                });
                console.log('Quote status updated.'); // Debugging

                // Fetch haulier data
                const haulierDoc = await db.collection('hauliers').doc(haulierId).get();
                const haulierData = haulierDoc.exists ? haulierDoc.data() : {};

                // Fetch quote data
                const quoteDoc = await db.collection('quotes').doc(quoteId).get();
                const quoteData = quoteDoc.exists ? quoteDoc.data() : {};

                // Prepare email parameters
                const emailParams = {
                    to_email: quoteData.userEmail, // Internal user's email from Firestore
                    subject: "New Tender Quote Submission Received",
                    internalUserName: quoteData.internalUserName || "Team",
                    tenderId: quoteId,
                    haulierName: haulierData.name || "Haulier Company",
                    haulierEmail: haulierData.email || "haulier@example.com",
                    price: price,
                    currency: currency,
                    validUntil: validUntil,
                    transitTime: transitTime,
                    transportMode: transportMode,
                    weightBucket: weightBucket,
                    incoterms: incoterms,
                    deliveryType: deliveryType,
                    loadType: loadType,
                    pallets: pallets,
                    palletType: palletType,
                    containerType: containerType,
                    airWeight: airWeight,
                    volume: volume,
                    isPeakSeason: isPeakSeason,
                    peakSeasonDetails: peakSeasonDetails,
                    urgency: urgency,
                    preferredDeliveryDate: preferredDeliveryDate,
                    hideDocuments: hideDocuments,
                    collectionCountry: collectionCountry,
                    collectionPostcode: collectionPostcode,
                    collectionLocation: collectionLocation,
                    deliveryCountry: deliveryCountry,
                    deliveryPostcode: deliveryPostcode,
                    deliveryLocation: deliveryLocation,
                    waypoint1: waypoint1,
                    waypoint2: waypoint2,
                    waypoint3: waypoint3,
                    waypoint4: waypoint4,
                    waypoint5: waypoint5,
                    quoteId: quoteId
                };

                console.log('Email parameters:', emailParams); // Debugging

                // Send notification email
                await sendNotificationEmail(emailParams);
                console.log('Notification email sent successfully!');

                displayMessage('Rate submitted successfully!', false);
                // Redirect after a short delay
                setTimeout(() => {
                    window.location.href = 'https://azelisshipping.github.io/AzelisLogistics/success.html';
                }, 2000);
            } catch (error) {
                console.error('Error submitting rate or sending email:', error);
                displayMessage('Failed to submit rate. Please try again.');
            }
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Submit Your Quote - Azelis Logistics</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script>emailjs.init("ZU_ZvcimnTfLR22wF");</script>
    <style>
        .azelis-blue { background-color: #003087; }
        .azelis-blue-hover:hover { background-color: #002670; }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltip-text {
            visibility: hidden;
            background-color: #333;
            color: white;
            text-align: center;
            padding: 5px;
            border-radius: 6px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="max-w-7xl mx-auto p-4 mt-10 bg-white rounded shadow">
        <div class="flex items-center justify-center mb-6">
            <img src="https://www.azelis.com/themes/custom/azelis_theme/logo.svg" alt="Azelis Logo" class="h-12">
        </div>
        <h2 class="text-3xl font-bold mb-6 text-center">Submit Your Quote</h2>
        
        <!-- Tender Overview -->
        <div id="tenderOverview" class="mb-8">
            <h3 class="text-2xl font-semibold mb-4">Tender Details</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Basic Information -->
                <div class="border p-4 rounded shadow-sm">
                    <h4 class="font-semibold mb-2">Basic Information</h4>
                    <p><strong>Tender ID:</strong> <span id="tenderId"></span></p>
                    <p><strong>Transport Mode:</strong> <span id="transportMode"></span></p>
                    <p><strong>Weight Bucket:</strong> <span id="weightBucket"></span></p>
                    <p><strong>Weight Type:</strong> <span id="weightType"></span></p>
                    <p><strong>Incoterms:</strong> <span id="incoterms"></span></p>
                    <p><strong>Currency:</strong> <span id="displayCurrency"></span></p>
                    <p><strong>Get All Pallet Rates:</strong> <span id="getAllPalletRates"></span></p>
                    <p><strong>Number of Pallets:</strong> <span id="pallets"></span></p>
                </div>
                
                <!-- Delivery Details -->
                <div class="border p-4 rounded shadow-sm">
                    <h4 class="font-semibold mb-2">Delivery Details</h4>
                    <p><strong>Delivery Type:</strong> <span id="deliveryType"></span></p>
                    <p><strong>Load Type:</strong> <span id="loadType"></span></p>
                    <p><strong>Pallets:</strong> <span id="pallets"></span></p>
                    <p><strong>Volume (CBM):</strong> <span id="volume"></span></p>
                </div>
                
                <!-- Additional Information -->
                <div class="border p-4 rounded shadow-sm">
                    <h4 class="font-semibold mb-2">Additional Information</h4>
                    <p><strong>Pallet Type:</strong> <span id="palletType"></span></p>
                    <p><strong>Container Type:</strong> <span id="containerType"></span></p>
                    <p><strong>Air Weight (KG):</strong> <span id="airWeight"></span></p>
                    <p><strong>Peak Season:</strong> <span id="peakSeason"></span></p>
                    <p><strong>Peak Details:</strong> <span id="peakDetails"></span></p>
                </div>
                
                <!-- Collection Details -->
                <div class="border p-4 rounded shadow-sm">
                    <h4 class="font-semibold mb-2">Collection Details</h4>
                    <p><strong>Country:</strong> <span id="collectionCountry"></span></p>
                    <p><strong>Postcode:</strong> <span id="collectionPostcode"></span></p>
                    <p><strong>Location:</strong> <span id="collectionLocation"></span></p>
                </div>
                
                <!-- Delivery Location -->
                <div class="border p-4 rounded shadow-sm">
                    <h4 class="font-semibold mb-2">Delivery Location</h4>
                    <p><strong>Country:</strong> <span id="deliveryCountry"></span></p>
                    <p><strong>Postcode:</strong> <span id="deliveryPostcode"></span></p>
                    <p><strong>Location:</strong> <span id="deliveryLocation"></span></p>
                </div>
                
                <!-- Service Requirements -->
                <div class="border p-4 rounded shadow-sm">
                    <h4 class="font-semibold mb-2">Service Requirements</h4>
                    <p><strong>Urgency:</strong> <span id="urgency"></span></p>
                    <p><strong>Preferred Delivery:</strong> <span id="preferredDelivery"></span></p>
                    <p><strong>Hide Documents:</strong> <span id="hideDocuments"></span></p>
                </div>

                <!-- Waypoints Section -->
                <div class="border p-4 rounded shadow-sm col-span-3">
                    <h4 class="font-semibold mb-2">Waypoints</h4>
                    <div id="waypointsContainer" class="grid grid-cols-1 gap-2">
                        <!-- Waypoints will be populated here -->
                    </div>
                </div>
            </div>
        </div>
<!-- Quote Submission Form -->
        <form id="submitQuoteForm" class="space-y-6">
            <!-- Basic Quote Details -->
            <div>
                <h3 class="text-xl font-semibold mb-2">Your Quote</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div id="basePriceField">
                        <label class="block text-sm font-medium mb-1">Base Price *</label>
                        <div class="tooltip">
                            <input type="number" name="price" required class="w-full p-2 border rounded" step="0.01">
                            <span class="tooltip-text">Enter your base price without surcharges</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Currency *</label>
                        <select name="currency" required class="w-full p-2 border rounded">
                            <option value="GBP">GBP (£)</option>
                            <option value="EUR">EUR (€)</option>
                            <option value="USD">USD ($)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Valid Until *</label>
                        <input type="date" name="validUntil" required class="w-full p-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Transit Time (Days) *</label>
                        <input type="number" name="transitTime" required class="w-full p-2 border rounded" min="1">
                    </div>
                </div>
            </div>
            
            <!-- Surcharges -->
            <div>
                <h3 class="text-xl font-semibold mb-2">Surcharges</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Fixed Rate Surcharges</label>
                        <div class="tooltip">
                            <input type="number" name="fixedRateSurcharges" class="w-full p-2 border rounded" step="0.01" value="0">
                            <span class="tooltip-text">Additional fixed costs (e.g., fuel surcharge)</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">% Surcharge</label>
                        <div class="tooltip">
                            <input type="number" name="percentSurcharge" class="w-full p-2 border rounded" step="0.01" value="0">
                            <span class="tooltip-text">Percentage-based surcharges</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Total</label>
                        <input type="number" name="total" readonly class="w-full p-2 border rounded bg-gray-100">
                    </div>
                </div>
            </div>

            <!-- Per-Pallet Rates -->
            <div id="palletRatesSection">
                <h3 class="text-xl font-semibold mb-2">Per-Pallet Rates</h3>
                <div class="overflow-x-auto">
                    <table class="w-full table-auto border">
                        <thead>
                            <tr class="bg-gray-200">
                                <th class="px-4 py-2 border">Pallet Quantity</th>
                                <th class="px-4 py-2 border">Rate</th>
                                <th class="px-4 py-2 border">Total</th>
                            </tr>
                        </thead>
                        <tbody id="palletRatesBody">
                            <!-- Pallet rates will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Hide Documents Option -->
            <div>
                <label class="flex items-center">
                    <input type="checkbox" name="hideDocuments" class="mr-2">
                    <span>Hide Commercial Documents</span>
                </label>
            </div>

            <!-- Submit Button -->
            <button type="submit" class="w-full azelis-blue text-white p-3 rounded hover:bg-blue-700">
                Submit Quote
            </button>
        </form>
        
        <div id="message" class="mt-4 text-center"></div>
    </div>
<script>
    // Firebase configuration
    const firebaseConfig = {
        // Your Firebase config here
        // ...
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Get URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const quoteId = urlParams.get('quoteId');
    const haulierId = urlParams.get('haulierId');

    let quoteData = null;

    function displayMessage(message, isError = false) {
        const messageDiv = document.getElementById('message');
        messageDiv.className = `mt-4 p-4 rounded ${isError ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
        messageDiv.textContent = message;
    }

    function formatCurrency(amount, currency) {
        return new Intl.NumberFormat('en-GB', {
            style: 'currency',
            currency: currency
        }).format(amount);
    }

    function calculateTotal() {
        const basePriceInput = document.querySelector('[name="price"]');
        if (basePriceInput && basePriceInput.offsetParent !== null) {
            const basePrice = parseFloat(basePriceInput.value) || 0;
            const fixedSurcharges = parseFloat(document.querySelector('[name="fixedRateSurcharges"]').value) || 0;
            const percentSurcharge = parseFloat(document.querySelector('[name="percentSurcharge"]').value) || 0;
            
            const percentAmount = basePrice * (percentSurcharge / 100);
            const total = basePrice + fixedSurcharges + percentAmount;
            
            document.querySelector('[name="total"]').value = total.toFixed(2);
        } else {
            document.querySelector('[name="total"]').value = '';
        }
    }

    function calculatePalletTotals() {
        const fixedSurcharges = parseFloat(document.querySelector('[name="fixedRateSurcharges"]').value) || 0;
        const percentSurcharge = parseFloat(document.querySelector('[name="percentSurcharge"]').value) || 0;
        
        for (let i = 1; i <= 24; i++) {
            const rateInput = document.querySelector(`[name="palletRate_${i}"]`);
            const totalInput = document.querySelector(`[name="palletTotal_${i}"]`);
            
            if (rateInput && totalInput) {
                const rate = parseFloat(rateInput.value) || 0;
                const percentAmount = rate * (percentSurcharge / 100);
                const total = rate + fixedSurcharges + percentAmount;
                totalInput.value = total.toFixed(2);
            }
        }
    }

    // Set up event listeners for price calculations
    document.querySelector('[name="price"]').addEventListener('input', calculateTotal);
    document.querySelector('[name="fixedRateSurcharges"]').addEventListener('input', () => {
        calculateTotal();
        calculatePalletTotals();
    });
    document.querySelector('[name="percentSurcharge"]').addEventListener('input', () => {
        calculateTotal();
        calculatePalletTotals();
    });

    async function populateTenderDetails() {
        if (!quoteId) {
            displayMessage('Missing quoteId parameter', true);
            return;
        }

        try {
            const quoteDoc = await db.collection('quotes').doc(quoteId).get();
            quoteData = quoteDoc.data();

            // Populate all the tender details
            document.getElementById('tenderId').textContent = quoteId;
            document.getElementById('transportMode').textContent = quoteData.transportMode || 'N/A';
            document.getElementById('weightBucket').textContent = quoteData.weightBucket || 'N/A';
            document.getElementById('weightType').textContent = quoteData.weightType === 'perPallet' ? 'Per Pallet' : 'Total Load';
            document.getElementById('incoterms').textContent = quoteData.incoterms || 'N/A';
            document.getElementById('displayCurrency').textContent = quoteData.currency || 'N/A';
            document.getElementById('getAllPalletRates').textContent = quoteData.getAllPalletRates ? 'Yes' : 'No';
            
            document.getElementById('deliveryType').textContent = quoteData.deliveryType || 'N/A';
            document.getElementById('loadType').textContent = quoteData.loadType || 'N/A';
            document.getElementById('pallets').textContent = quoteData.pallets || 'N/A';
            document.getElementById('volume').textContent = quoteData.volume ? `${quoteData.volume} CBM` : 'N/A';
            
            document.getElementById('palletType').textContent = quoteData.palletType || 'N/A';
            document.getElementById('containerType').textContent = quoteData.containerType || 'N/A';
            document.getElementById('airWeight').textContent = quoteData.airWeight ? `${quoteData.airWeight} kg` : 'N/A';
            document.getElementById('peakSeason').textContent = quoteData.isPeakSeason ? 'Yes' : 'No';
            document.getElementById('peakDetails').textContent = quoteData.peakSeasonDetails || 'N/A';

            document.getElementById('collectionCountry').textContent = quoteData.collection?.country || 'N/A';
            document.getElementById('collectionPostcode').textContent = quoteData.collection?.postcode || 'N/A';
            document.getElementById('collectionLocation').textContent = quoteData.collection?.location || 'N/A';

            document.getElementById('deliveryCountry').textContent = quoteData.delivery?.country || 'N/A';
            document.getElementById('deliveryPostcode').textContent = quoteData.delivery?.postcode || 'N/A';
            document.getElementById('deliveryLocation').textContent = quoteData.delivery?.location || 'N/A';

            document.getElementById('urgency').textContent = quoteData.urgency || 'N/A';
            document.getElementById('preferredDelivery').textContent = quoteData.preferredDeliveryDate || 'N/A';
            document.getElementById('hideDocuments').textContent = quoteData.hideDocuments ? 'Yes' : 'No';

            // Populate waypoints
            const waypointsContainer = document.getElementById('waypointsContainer');
            if (quoteData.waypoints && quoteData.waypoints.length > 0) {
                waypointsContainer.innerHTML = quoteData.waypoints.map((waypoint, index) => `
                    <div class="p-2 bg-gray-50 rounded">
                        <p class="font-medium">Waypoint ${index + 1}</p>
                        <p>Country: ${waypoint.country}</p>
                        <p>Postcode: ${waypoint.postcode}</p>
                    </div>
                `).join('');
            } else {
                waypointsContainer.innerHTML = '<p class="text-gray-500">No waypoints specified</p>';
            }

            // Show/hide Base Price field based on getAllPalletRates
            const basePriceField = document.getElementById('basePriceField');
            const basePriceInput = document.querySelector('[name="price"]');
            if (quoteData.getAllPalletRates) {
                basePriceField.style.display = 'none';
                basePriceInput.removeAttribute('required');
            } else {
                basePriceField.style.display = 'block';
                basePriceInput.setAttribute('required', 'required');
            }

            // Populate pallet rates table
            const palletRatesBody = document.getElementById('palletRatesBody');
            if (quoteData.getAllPalletRates) {
                // Create container for bulk upload options
                const bulkUploadContainer = document.createElement('div');
                bulkUploadContainer.className = 'mb-6 p-4 border rounded';
            
                // Add Excel import/export buttons
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'flex gap-4 mb-4';
            
                // Export template button
                const exportTemplateBtn = document.createElement('button');
                exportTemplateBtn.className = 'px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600';
                exportTemplateBtn.textContent = 'Export Template';
                exportTemplateBtn.onclick = () => {
                    const wb = XLSX.utils.book_new();
                    // Include base price and surcharges in template
                    const ws_data = [
                        ['Pallets', 'Base Rate', 'Fixed Surcharge', 'Percent Surcharge', 'Total'],
                        ...Array.from({length: 24}, (_, i) => [`${i + 1} Pallet`, '', '', '', '=B' + (i+2) + '+C' + (i+2) + '+(B' + (i+2) + '*D' + (i+2) + '/100)'])
                    ];
                    const ws = XLSX.utils.aoa_to_sheet(ws_data);
                    XLSX.utils.book_append_sheet(wb, ws, "Pallet Rates");
                    XLSX.writeFile(wb, "pallet_rates_template.xlsx");
                };
            
                // Import rates button and input
                const importInput = document.createElement('input');
                importInput.type = 'file';
                importInput.accept = '.xlsx,.xls';
                importInput.className = 'hidden';
                importInput.onchange = (e) => {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                        
                        jsonData.forEach(row => {
                            const palletNum = row['Pallets'].split(' ')[0];
                            const baseRate = parseFloat(row['Base Rate']) || 0;
                            const fixedSurcharge = parseFloat(row['Fixed Surcharge']) || 0;
                            const percentSurcharge = parseFloat(row['Percent Surcharge']) || 0;
                            
                            const percentAmount = baseRate * (percentSurcharge / 100);
                            const total = baseRate + fixedSurcharge + percentAmount;
                            
                            const rateInput = document.querySelector(`[name="palletRate_${palletNum}"]`);
                            const totalInput = document.querySelector(`[name="palletTotal_${palletNum}"]`);
                            if (rateInput && totalInput) {
                                rateInput.value = baseRate.toFixed(2);
                                totalInput.value = total.toFixed(2);
                            }
                        });
                    };
                    reader.readAsArrayBuffer(file);
                };
            
                const importBtn = document.createElement('button');
                importBtn.className = 'px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600';
                importBtn.textContent = 'Import Rates';
                importBtn.onclick = () => importInput.click();
            
                buttonContainer.appendChild(exportTemplateBtn);
                buttonContainer.appendChild(importBtn);
                buttonContainer.appendChild(importInput);
            
                // Create table for entering rates
                for (let i = 1; i <= 24; i++) {
                    const row = document.createElement('tr');
                    
                    const rateInputName = `palletRate_${i}`;
                    const totalInputName = `palletTotal_${i}`;
                    
                    row.innerHTML = `
                        <td class="px-4 py-2 border text-center">${i}</td>
                        <td class="px-4 py-2 border">
                            <input type="number" 
                                   name="${rateInputName}" 
                                   class="w-full p-2 border rounded" 
                                   step="0.01" 
                                   placeholder="Rate for ${i} pallet${i > 1 ? 's' : ''}">
                        </td>
                        <td class="px-4 py-2 border">
                            <input type="number" 
                                   name="${totalInputName}" 
                                   class="w-full p-2 border rounded bg-gray-100" 
                                   readonly>
                        </td>
                    `;
                    palletRatesBody.appendChild(row);
                    
                    const rateInput = row.querySelector(`[name="${rateInputName}"]`);
                    rateInput.addEventListener('input', calculatePalletTotals);
                }
            
                palletRatesBody.parentElement.parentElement.insertBefore(buttonContainer, palletRatesBody.parentElement);
            
                // Create textarea for bulk paste
                const bulkPasteContainer = document.createElement('div');
                bulkPasteContainer.className = 'mb-4';
                const bulkPasteLabel = document.createElement('label');
                bulkPasteLabel.className = 'block text-sm font-medium mb-2';
                bulkPasteLabel.textContent = 'Paste rates from Excel (one rate per line)';
                const bulkPasteArea = document.createElement('textarea');
                bulkPasteArea.className = 'w-full p-2 border rounded';
                bulkPasteArea.rows = 5;
                bulkPasteArea.onchange = (e) => {
                    const rates = e.target.value.split('\n');
                    rates.forEach((rate, index) => {
                        if (index < 24) {
                            const rateInput = document.querySelector(`[name="palletRate_${index + 1}"]`);
                            if (rateInput) {
                                rateInput.value = rate.trim();
                            }
                        }
                    });
                    calculatePalletTotals();
                };
                
                bulkPasteContainer.appendChild(bulkPasteLabel);
                bulkPasteContainer.appendChild(bulkPasteArea);
                palletRatesBody.parentElement.parentElement.insertBefore(bulkPasteContainer, palletRatesBody.parentElement);
            } else if (quoteData.loadType === 'Partial Load' || quoteData.loadType === 'LCL') {
                // Show only single pallet rate input
                const pallets = quoteData.pallets || 1;
                const row = document.createElement('tr');
                
                const rateInputName = `palletRate_${pallets}`;
                const totalInputName = `palletTotal_${pallets}`;
                
                row.innerHTML = `
                    <td class="px-4 py-2 border text-center">${pallets}</td>
                    <td class="px-4 py-2 border">
                        <input type="number" 
                               name="${rateInputName}" 
                               class="w-full p-2 border rounded" 
                               step="0.01" 
                               placeholder="Rate for ${pallets} pallet${pallets > 1 ? 's' : ''}">
                    </td>
                    <td class="px-4 py-2 border">
                        <input type="number" 
                               name="${totalInputName}" 
                               class="w-full p-2 border rounded bg-gray-100" 
                               readonly>
                    </td>
                `;
                palletRatesBody.appendChild(row);
                
                const rateInput = row.querySelector(`[name="${rateInputName}"]`);
                rateInput.addEventListener('input', calculatePalletTotals);
            } else {
                // Hide pallet rates section for FTL
                document.getElementById('palletRatesSection').style.display = 'none';
            }

            // Show/hide pallet rates section based on load type
            const palletRatesSection = document.getElementById('palletRatesSection');
            palletRatesSection.style.display = quoteData.loadType === 'Full Truck Load' ? 'none' : 'block';

        } catch (error) {
            console.error('Error fetching quote:', error);
            displayMessage('Error loading quote details', true);
        }
    }

    // Handle form submission
    document.getElementById('submitQuoteForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);

        try {
            if (!quoteData) throw new Error('Quote data not loaded');

            // Get all pallet rates
            const palletRates = {};
            if (quoteData.loadType !== 'Full Truck Load') {
                for (let i = 1; i <= 24; i++) {
                    const rate = parseFloat(formData.get(`palletRate_${i}`));
                    const total = parseFloat(formData.get(`palletTotal_${i}`));
                    if (!isNaN(rate)) {
                        palletRates[i] = { rate, total };
                    }
                }
            }

            // Generate pallet rates HTML for email
            let palletRatesHTML = '<table style="width:100%; border-collapse:collapse;">';
            palletRatesHTML += '<tr><th style="border:1px solid #ddd;padding:8px;">Pallets</th><th style="border:1px solid #ddd;padding:8px;">Rate</th><th style="border:1px solid #ddd;padding:8px;">Total</th></tr>';
            Object.entries(palletRates).forEach(([qty, { rate, total }]) => {
                palletRatesHTML += `
                    <tr>
                        <td style="border:1px solid #ddd;padding:8px;">${qty}</td>
                        <td style="border:1px solid #ddd;padding:8px;">${formatCurrency(rate, formData.get('currency'))}</td>
                        <td style="border:1px solid #ddd;padding:8px;">${formatCurrency(total, formData.get('currency'))}</td>
                    </tr>
                `;
            });
            palletRatesHTML += '</table>';

            // Get haulier details
            const haulierDoc = await db.collection('hauliers').doc(haulierId).get();
            const haulierData = haulierDoc.data();

            // Email parameters for internal notification
            const emailParams = {
                to_email: quoteData.userEmail,
                subject: `Quote Response Received - ${quoteId}`,
                quoteId: quoteId,
                haulierName: haulierData.name,
                haulierEmail: haulierData.email,
                price: formData.get('price'),
                currency: formData.get('currency'),
                validUntil: formData.get('validUntil'),
                transitTime: formData.get('transitTime'),
                fixedRateSurcharges: formData.get('fixedRateSurcharges') || '0',
                percentSurcharge: formData.get('percentSurcharge') || '0',
                total: formData.get('total'),
                hideDocuments: formData.get('hideDocuments') ? 'Yes' : 'No',
                palletRatesHTML: palletRatesHTML,
                getAllPalletRates: quoteData.getAllPalletRates ? 'Yes' : 'No',
                
                // Route details
                collectionCountry: quoteData.collection?.country || 'N/A',
                collectionPostcode: quoteData.collection?.postcode || 'N/A',
                deliveryCountry: quoteData.delivery?.country || 'N/A',
                deliveryPostcode: quoteData.delivery?.postcode || 'N/A',
                deliveryLocation: quoteData.delivery?.location || 'N/A',
                
                // Transport details
                transportMode: quoteData.transportMode,
                weightBucket: quoteData.weightBucket,
                deliveryType: quoteData.deliveryType,
                loadType: quoteData.loadType,
                containerType: quoteData.containerType || 'N/A',
                airWeight: quoteData.airWeight || 'N/A',
                volume: quoteData.volume || 'N/A',
                
                // Additional details
                isPeakSeason: quoteData.isPeakSeason ? 'Yes' : 'No',
                peakSeasonDetails: quoteData.peakSeasonDetails || 'N/A',
                urgency: quoteData.urgency || 'N/A',
                preferredDeliveryDate: quoteData.preferredDeliveryDate || 'N/A'
            };

            // Add waypoints to email parameters
            for (let i = 1; i <= 5; i++) {
                const waypoint = quoteData.waypoints?.[i - 1];
                emailParams[`waypoint${i}`] = waypoint ? 
                    `${waypoint.country} - ${waypoint.postcode}` : 
                    'N/A';
            }

            // Send email notification
            await emailjs.send('Azelis_Logistics', 'template_12utb0n', emailParams);

            // Update quote in Firestore
            const quoteUpdate = {
                responses: firebase.firestore.FieldValue.arrayUnion({
                    haulierId: haulierId,
                    haulierName: haulierData.name,
                    price: parseFloat(formData.get('price')),
                    currency: formData.get('currency'),
                    validUntil: formData.get('validUntil'),
                    transitTime: parseInt(formData.get('transitTime')),
                    fixedRateSurcharges: parseFloat(formData.get('fixedRateSurcharges')) || 0,
                    percentSurcharge: parseFloat(formData.get('percentSurcharge')) || 0,
                    total: parseFloat(formData.get('total')),
                    hideDocuments: formData.get('hideDocuments') === 'on',
                    palletRates: palletRates,
                    submittedAt: new Date()
                })
            };

            await db.collection('quotes').doc(quoteId).update(quoteUpdate);

            // Save to 'rates' collection
            const rateData = {
                quoteId: quoteId,
                haulierId: haulierId,
                haulierName: haulierData.name,
                haulierEmail: haulierData.email,
                userEmail: quoteData.userEmail,
                price: parseFloat(formData.get('price')),
                currency: formData.get('currency'),
                validUntil: formData.get('validUntil'),
                transitTime: parseInt(formData.get('transitTime')),
                fixedRateSurcharges: parseFloat(formData.get('fixedRateSurcharges')) || 0,
                percentSurcharge: parseFloat(formData.get('percentSurcharge')) || 0,
                total: parseFloat(formData.get('total')),
                hideDocuments: formData.get('hideDocuments') === 'on',
                palletRates: palletRates,
                submittedAt: new Date(),
                transportMode: quoteData.transportMode,
                haulierTransportModes: haulierData.transportModes,
                collection: quoteData.collection || {},
                delivery: quoteData.delivery || {},
                weightBucket: quoteData.weightBucket || 'N/A',
                weightType: quoteData.weightType || 'N/A',
                incoterms: quoteData.incoterms || 'N/A',
                deliveryType: quoteData.deliveryType || 'N/A',
                loadType: quoteData.loadType || 'N/A',
                pallets: quoteData.pallets || 'N/A',
                volume: quoteData.volume || 'N/A',
                palletType: quoteData.palletType || 'N/A',
                containerType: quoteData.containerType || 'N/A',
                airWeight: quoteData.airWeight || 'N/A',
                isPeakSeason: quoteData.isPeakSeason || false,
                peakSeasonDetails: quoteData.peakSeasonDetails || 'N/A',
                urgency: quoteData.urgency || 'N/A',
                preferredDeliveryDate: quoteData.preferredDeliveryDate || 'N/A',
                waypoints: quoteData.waypoints || []
            };
            await db.collection('rates').add(rateData);

            displayMessage('Quote submitted successfully!');
            
            // Disable form after successful submission
            document.getElementById('submitQuoteForm').style.opacity = '0.5';
            document.getElementById('submitQuoteForm').style.pointerEvents = 'none';

        } catch (error) {
            console.error('Error submitting quote:', error);
            displayMessage('Error submitting quote. Please try again.', true);
        }
    });

    // Initialize page
    window.addEventListener('DOMContentLoaded', populateTenderDetails);
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Submit Your Quote - Azelis Logistics</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        .azelis-blue { background-color: #003087; }
        .azelis-blue-hover:hover { background-color: #002670; }
        .pallet-rates-table { max-height: 500px; overflow-y: auto; }
        .table-header { position: sticky; top: 0; background: white; z-index: 10; }
        .import-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .import-modal {
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            max-width: 90%;
            width: 600px;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <!-- Dependencies -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDiIRLwLeMAf1VZbZ7ygvGDu-gZH6sA424",
            authDomain: "azelislogistics.firebaseapp.com",
            projectId: "azelislogistics",
            storageBucket: "azelislogistics.appspot.com",
            messagingSenderId: "13102382958",
            appId: "1:13102382958:web:82a3324843432519cb8b7f"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Initialize EmailJS
        emailjs.init("ZU_ZvcimnTfLR22wF");
    </script>

    <script type="text/babel">
        const TenderForm = () => {
            const [quoteData, setQuoteData] = React.useState(null);
            const [loading, setLoading] = React.useState(true);
            const [error, setError] = React.useState(null);
            const [sending, setSending] = React.useState(false);
            const [palletRates, setPalletRates] = React.useState({});
            const [surcharges, setSurcharges] = React.useState({
                fixed: 0,
                percent: 0
            });
            const [showImportModal, setShowImportModal] = React.useState(false);
            const [importErrors, setImportErrors] = React.useState([]);
            const [importStats, setImportStats] = React.useState(null);
            const [customFields, setCustomFields] = React.useState({});

            const params = new URLSearchParams(window.location.search);
            const quoteId = params.get('quoteId');
            const haulierId = params.get('haulierId');

            // ... [Previous useEffect and handlers remain the same]

            const handleFileImport = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(sheet);
                        
                        // Process the imported data
                        const processedRates = {};
                        jsonData.forEach(row => {
                            if (row.Pallets && row.Rate) {
                                processedRates[row.Pallets] = parseFloat(row.Rate);
                            }
                        });
                        
                        setPalletRates(processedRates);
                        setImportStats({
                            total: jsonData.length,
                            processed: Object.keys(processedRates).length
                        });
                        setShowImportModal(false);
                    } catch (err) {
                        setImportErrors([`Error processing file: ${err.message}`]);
                    }
                };
                reader.readAsArrayBuffer(file);
            };

            const handleExport = () => {
                const exportData = Object.entries(palletRates).map(([pallets, rate]) => ({
                    Pallets: pallets,
                    Rate: rate,
                    'Total (inc. Surcharges)': calculateTotal(rate)
                }));

                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Pallet Rates");
                XLSX.writeFile(wb, `pallet_rates_${quoteId}.xlsx`);
            };

            // ... [Previous helper functions remain the same]

            if (loading) return <div className="text-center p-8">Loading...</div>;
            if (error) return <div className="text-red-600 p-8">{error}</div>;
            if (!quoteData) return null;

            return (
                <div className="max-w-7xl mx-auto p-4">
                    <div className="bg-white rounded-lg shadow-lg p-6">
                        {/* Header */}
                        <div className="flex justify-between items-center mb-6">
                            <img src="https://www.azelis.com/themes/custom/azelis_theme/logo.svg" alt="Azelis Logo" className="h-12" />
                            <div className="text-right">
                                <h2 className="text-xl font-bold">Quote Response</h2>
                                <p className="text-sm text-gray-600">Reference: {quoteId}</p>
                            </div>
                        </div>

                        {/* Quote Details */}
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
                            <div className="border rounded p-4">
                                <h3 className="font-semibold mb-2">Collection Details</h3>
                                <p>Country: {quoteData.collection?.country}</p>
                                <p>Postcode: {quoteData.collection?.postcode}</p>
                                <p>Location: {quoteData.collection?.location || 'N/A'}</p>
                            </div>

                            {quoteData.waypoints?.length > 0 && (
                                <div className="border rounded p-4">
                                    <h3 className="font-semibold mb-2">Waypoints</h3>
                                    {quoteData.waypoints.map((wp, index) => (
                                        <div key={index} className="mb-2">
                                            <p>Stop {index + 1}: {wp.country} - {wp.postcode}</p>
                                        </div>
                                    ))}
                                </div>
                            )}

                            <div className="border rounded p-4">
                                <h3 className="font-semibold mb-2">Delivery Details</h3>
                                <p>Country: {quoteData.delivery?.country}</p>
                                <p>Postcode: {quoteData.delivery?.postcode}</p>
                                <p>Location: {quoteData.delivery?.location || 'N/A'}</p>
                            </div>

                            <div className="border rounded p-4">
                                <h3 className="font-semibold mb-2">Transport Details</h3>
                                <p>Mode: {quoteData.transportMode}</p>
                                <p>Weight: {quoteData.weightBucket}</p>
                                <p>Weight Type: {quoteData.weightType}</p>
                                <p>Load Type: {quoteData.loadType}</p>
                                <p>Delivery Type: {quoteData.deliveryType}</p>
                            </div>

                            <div className="border rounded p-4">
                                <h3 className="font-semibold mb-2">Additional Details</h3>
                                <p>Incoterms: {quoteData.incoterms}</p>
                                {quoteData.pallets && <p>Pallets: {quoteData.pallets}</p>}
                                {quoteData.palletType && <p>Pallet Type: {quoteData.palletType}</p>}
                                {quoteData.containerType && <p>Container Type: {quoteData.containerType}</p>}
                                {quoteData.volume && <p>Volume: {quoteData.volume} CBM</p>}
                                {quoteData.airWeight && <p>Air Weight: {quoteData.airWeight} kg</p>}
                            </div>

                            {(quoteData.isPeakSeason || quoteData.urgency || quoteData.preferredDeliveryDate) && (
                                <div className="border rounded p-4">
                                    <h3 className="font-semibold mb-2">Special Requirements</h3>
                                    {quoteData.isPeakSeason && (
                                        <p>Peak Season: Yes - {quoteData.peakSeasonDetails}</p>
                                    )}
                                    {quoteData.urgency && <p>Urgency: {quoteData.urgency}</p>}
                                    {quoteData.preferredDeliveryDate && (
                                        <p>Preferred Delivery: {quoteData.preferredDeliveryDate}</p>
                                    )}
                                </div>
                            )}
                        </div>

                        {/* Quote Form */}
                        <form onSubmit={handleSubmit} className="space-y-6">
                            {/* Basic Details */}
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label className="block text-sm font-medium mb-1">Currency *</label>
                                    <select name="currency" required className="w-full p-2 border rounded">
                                        <option value="GBP">GBP (£)</option>
                                        <option value="EUR">EUR (€)</option>
                                        <option value="USD">USD ($)</option>
                                    </select>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium mb-1">Valid Until *</label>
                                    <input
                                        type="date"
                                        name="validUntil"
                                        required
                                        min={new Date().toISOString().split('T')[0]}
                                        className="w-full p-2 border rounded"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium mb-1">Transit Time (Days) *</label>
                                    <input
                                        type="number"
                                        name="transitTime"
                                        required
                                        min="1"
                                        className="w-full p-2 border rounded"
                                    />
                                </div>
                            </div>

                            {/* Pricing Section */}
                            {quoteData.loadType === 'Full Truck Load' ? (
                                <div>
                                    <h3 className="text-lg font-medium mb-4">Full Truck Load Pricing</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Base Price *</label>
                                            <input
                                                type="number"
                                                name="basePrice"
                                                required
                                                step="0.01"
                                                className="w-full p-2 border rounded"
                                            />
                                        </div>
                                    </div>
                                </div>
                            ) : (
                                <div>
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="text-lg font-medium">Pallet Rates</h3>
                                        <div className="flex space-x-2">
                                            <button
                                                type="button"
                                                onClick={() => setShowImportModal(true)}
                                                className="px-4 py-2 text-blue-600 hover:text-blue-800"
                                            >
                                                Import Rates
                                            </button>
                                            <button
                                                type="button"
                                                onClick={handleExport}
                                                className="px-4 py-2 text-blue-600 hover:text-blue-800"
                                            >
                                                Export Rates
                                            </button>
                                        </div>
                                    </div>
                                    <div className="pallet-rates-table">
                                        <table className="w-full">
                                            <thead className="table-header">
                                                <tr>
                                                    <th className="px-4 py-2 text-left">Pallets</th>
                                                    <th className="px-4 py-2 text-left">Rate</th>
                                                    <th className="px-4 py-2 text-left">Total (inc. Surcharges)</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {[...Array(quoteData.pallets || 24)].map((_, i) => (
                                                    <tr key={i}>
                                                        <td className="px-4 py-2">{i + 1}</td>
                                                        <td className="px-4 py-2">
                                                            <input
                                                                type="number"
                                                                step="0.01"
                                                                className="w-full p-2 border rounded"
                                                                value={palletRates[i + 1] || ''}
                                                                onChange={(e) => handlePalletRateChange(i + 1, e.target.value)}
                                                                required
                                                            />
                                                        </td>
                                                        <td className="px-4 py-2">
                                                            {calculateTotal(palletRates[i + 1]).toFixed(2)}
                                                        
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            )}

                            {/* Surcharges */}
                            <div>
                                <h3 className="text-lg font-medium mb-4">Surcharges</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Fixed Surcharge</label>
                                        <input
                                            type="number"
                                            name="fixedSurcharge"
                                            step="0.01"
                                            className="w-full p-2 border rounded"
                                            value={surcharges.fixed}
                                            onChange={(e) => setSurcharges(prev => ({
                                                ...prev,
                                                fixed: e.target.value
                                            }))}
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Percentage Surcharge (%)</label>
                                        <input
                                            type="number"
                                            name="percentSurcharge"
                                            step="0.01"
                                            className="w-full p-2 border rounded"
                                            value={surcharges.percent}
                                            onChange={(e) => setSurcharges(prev => ({
                                                ...prev,
                                                percent: e.target.value
                                            }))}
                                        />
                                    </div>
                                </div>
                            </div>

                            <button
                                type="submit"
                                disabled={sending}
                                className="w-full azelis-blue text-white p-3 rounded-lg hover:bg-blue-700 disabled:opacity-50"
                            >
                                {sending ? 'Submitting...' : 'Submit Quote'}
                            </button>
                        </form>

                        {error && (
                            <div className="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700">
                                {error}
                            </div>
                        )}
                    </div>

                    {/* Import Modal */}
                    {showImportModal && (
                        <div className="import-overlay">
                            <div className="import-modal">
                                <h3 className="text-lg font-semibold mb-4">Import Rates from Excel</h3>
                                <input
                                    type="file"
                                    accept=".xlsx,.xls"
                                    onChange={handleFileImport}
                                    className="mb-4"
                                />
                                {importStats && (
                                    <div className="mb-4 p-3 bg-green-50 text-green-700 rounded">
                                        <p>Total rows: {importStats.total}</p>
                                        <p>Processed: {importStats.processed}</p>
                                    </div>
                                )}
                                {importErrors.length > 0 && (
                                    <div className="mb-4 p-3 bg-red-50 text-red-700 rounded">
                                        {importErrors.map((error, index) => (
                                            <p key={index}>{error}</p>
                                        ))}
                                    </div>
                                )}
                                <div className="flex justify-end">
                                    <button
                                        onClick={() => setShowImportModal(false)}
                                        className="px-4 py-2 text-gray-600 hover:text-gray-800"
                                    >
                                        Close
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.render(<TenderForm />, document.getElementById('root'));
    </script>
</body>
</html>

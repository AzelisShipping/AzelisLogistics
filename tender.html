<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDiIRLwLeMAf1VZbZ7ygvGDu-gZH6sA424",
        authDomain: "azelislogistics.firebaseapp.com",
        projectId: "azelislogistics",
        storageBucket: "azelislogistics.appspot.com",
        messagingSenderId: "13102382958",
        appId: "1:13102382958:web:82a3324843432519cb8b7f",
        measurementId: "G-Q6JNN8DHJQ"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const urlParams = new URLSearchParams(window.location.search);
    const quoteId = urlParams.get('quoteId');
    const haulierId = urlParams.get('haulierId');

    // Get quote data to populate form
    async function getQuoteData() {
        if (!quoteId) {
            alert('Missing quoteId in URL parameters.');
            return null;
        }
        const quoteDoc = await db.collection('quotes').doc(quoteId).get();
        if (!quoteDoc.exists) {
            alert('Quote not found.');
            return null;
        }
        return quoteDoc.data();
    }

    document.getElementById('submitQuoteForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const quoteData = await getQuoteData();
        
        if (!quoteData) {
            return;
        }

        // Optional: Validate haulierId if necessary
        if (!haulierId) {
            alert('Missing haulierId in URL parameters.');
            return;
        }

        try {
            // Add rate to 'rates' collection
            const rateData = {
                collectionCountry: quoteData.collection.country,
                collectionPostcode: quoteData.collection.postcode,
                deliveryCountry: quoteData.delivery.country,
                deliveryPostcode: quoteData.delivery.postcode,
                deliveryType: quoteData.deliveryType || 'STD',
                priceValidity: formData.get('validUntil'),
                isFullTruckLoad: quoteData.isFullTruckLoad || false,
                fullTruckLoadPrice: quoteData.isFullTruckLoad ? parseFloat(formData.get('price')) : null,
                prices: quoteData.isFullTruckLoad ? {} : {
                    [quoteData.pallets]: parseFloat(formData.get('price'))
                },
                haulierId: haulierId, // Associate rate with haulier
                submittedAt: new Date()
            };

            await db.collection('rates').add(rateData);

            // Update quote status
            await db.collection('quotes').doc(quoteId).update({
                status: 'responded'
            });

            alert('Rate submitted successfully!');
            window.location.href = 'https://azelisshipping.github.io/AzelisLogistics/success.html';
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to submit rate. Please try again.');
        }
    });
</script>
